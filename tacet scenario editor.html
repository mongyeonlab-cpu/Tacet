<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåô Îã¨Ïùò ÏÑ∏Í≥Ñ - ÏãúÎÇòÎ¶¨Ïò§ ÏóêÎîîÌÑ∞ v3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', 'Pretendard', sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
        }

        /* Î©îÏù∏ Î†àÏù¥ÏïÑÏõÉ */
        .app {
            display: grid;
            grid-template-columns: 220px 1fr 300px;
            grid-template-rows: 32px 1fr 28px;
            height: 100vh;
        }

        /* ÏÉÅÎã® Î©îÎâ¥Î∞î */
        .menubar {
            grid-column: 1 / -1;
            background: #3c3c3c;
            border-bottom: 1px solid #252526;
            display: flex;
            align-items: center;
            padding: 0 8px;
            gap: 2px;
        }

        .menu-group {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 0 4px;
        }

        .menu-group + .menu-group {
            border-left: 1px solid #555;
            margin-left: 4px;
            padding-left: 8px;
        }

        .menu-btn {
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .menu-btn:hover {
            background: #505050;
        }

        .menu-btn:active {
            background: #404040;
        }

        .menu-btn.active {
            background: #094771;
        }

        .menu-title {
            margin-left: auto;
            font-size: 11px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-save-indicator {
            color: #4ec9b0;
            font-size: 10px;
        }

        .auto-save-indicator.saving {
            color: #dcdcaa;
        }

        /* ÏôºÏ™Ω Ìå®ÎÑê */
        .left-panel {
            background: #252526;
            border-right: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-tabs {
            display: flex;
            background: #2d2d30;
            border-bottom: 1px solid #3c3c3c;
        }

        .panel-tab {
            flex: 1;
            padding: 6px 8px;
            text-align: center;
            font-size: 11px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #888;
        }

        .panel-tab:hover {
            color: #ccc;
        }

        .panel-tab.active {
            color: #fff;
            border-bottom-color: #0078d4;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            display: none;
        }

        .panel-content.active {
            display: block;
        }

        /* Day Î¶¨Ïä§Ìä∏ */
        .day-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 3px solid transparent;
        }

        .day-item:hover {
            background: #2a2d2e;
        }

        .day-item.active {
            background: #37373d;
            border-left-color: #0078d4;
        }

        .day-item .count {
            margin-left: auto;
            font-size: 10px;
            color: #666;
            background: #3c3c3c;
            padding: 1px 6px;
            border-radius: 10px;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ Î¶¨Ïä§Ìä∏ */
        .char-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }

        .char-item:hover {
            background: #2a2d2e;
        }

        .char-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #555;
        }

        .char-name {
            flex: 1;
        }

        .char-actions {
            display: flex;
            gap: 4px;
        }

        .char-actions button {
            padding: 2px 6px;
            background: transparent;
            border: 1px solid #555;
            color: #888;
            font-size: 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        .char-actions button:hover {
            background: #3c3c3c;
        }

        .add-char-btn {
            padding: 8px;
            background: transparent;
            border: 1px dashed #555;
            color: #888;
            cursor: pointer;
            margin: 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .add-char-btn:hover {
            background: #2a2d2e;
            border-color: #888;
        }

        /* Î≥ÄÏàò Ìå®ÎÑê */
        .var-section {
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        .var-section-title {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .var-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
        }

        .var-name {
            color: #9cdcfe;
        }

        .var-value {
            color: #b5cea8;
            font-family: monospace;
        }

        /* ÏóêÏÖã Ìå®ÎÑê */
        .asset-category {
            border-bottom: 1px solid #333;
        }

        .asset-category-header {
            padding: 8px 12px;
            background: #2d2d30;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }

        .asset-category-header:hover {
            background: #333;
        }

        .asset-add-btn {
            margin-left: auto;
            width: 18px;
            height: 18px;
            background: #0e639c;
            border: none;
            border-radius: 3px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .asset-add-btn:hover {
            background: #1177bb;
        }

        .asset-list {
            padding: 4px 8px;
        }

        .asset-item {
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .asset-item:hover {
            background: #37373d;
        }

        .asset-item .asset-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .asset-item .asset-actions {
            display: none;
            gap: 4px;
        }

        .asset-item:hover .asset-actions {
            display: flex;
        }

        .asset-item .asset-actions button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 10px;
            padding: 2px;
        }

        .asset-item .asset-actions button:hover {
            color: #fff;
        }

        .asset-preview {
            width: 24px;
            height: 24px;
            background: #1e1e1e;
            border-radius: 3px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .asset-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        /* Í≤ÄÏÉâ Î∞î */
        .search-bar {
            padding: 8px;
            border-bottom: 1px solid #333;
        }

        .search-input {
            width: 100%;
            padding: 6px 10px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 12px;
        }

        .search-input:focus {
            outline: none;
            border-color: #0078d4;
        }

        .search-input::placeholder {
            color: #666;
        }

        /* Ï§ëÏïô Ìå®ÎÑê */
        .center-panel {
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Ïù¥Î≤§Ìä∏ Ìà¥Î∞î */
        .event-toolbar {
            background: #2d2d30;
            padding: 4px 8px;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 4px 8px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #ccc;
            font-size: 11px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .toolbar-btn:hover {
            background: #505050;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background: #555;
            margin: 0 4px;
        }

        .toolbar-search {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toolbar-search input {
            padding: 4px 8px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 3px;
            color: #e0e0e0;
            font-size: 11px;
            width: 150px;
        }

        .toolbar-search input:focus {
            outline: none;
            border-color: #0078d4;
        }

        /* Ïù¥Î≤§Ìä∏ Î¶¨Ïä§Ìä∏ */
        .event-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .event-list {
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            min-height: 100%;
        }

        /* Ïù¥Î≤§Ìä∏ Î∏îÎ°ù */
        .event-block {
            display: flex;
            align-items: stretch;
            border-bottom: 1px solid #333;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.1s;
            position: relative;
        }

        .event-block:hover {
            background: #2a2d2e;
        }

        .event-block.selected {
            background: #094771;
        }

        .event-block.search-match {
            background: #5a3d00;
        }

        .event-block.selected.search-match {
            background: #094771;
            box-shadow: inset 0 0 0 2px #dcdcaa;
        }

        .event-block.bookmark::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #f5af19;
        }

        .event-block.error {
            background: rgba(220, 53, 69, 0.2);
        }

        .event-block.dragging {
            opacity: 0.5;
        }

        .event-block.drag-over {
            border-top: 2px solid #569cd6;
            margin-top: -2px;
        }

        .event-line-num {
            width: 35px;
            min-width: 35px;
            padding: 4px;
            text-align: right;
            font-size: 10px;
            color: #5a5a5a;
            background: #1e1e1e;
            border-right: 1px solid #333;
            font-family: monospace;
        }

        .event-indent {
            width: 20px;
            min-width: 20px;
            background: linear-gradient(90deg, transparent 9px, #333 9px, #333 11px, transparent 11px);
        }

        .event-icon {
            width: 26px;
            min-width: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .event-content {
            flex: 1;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 24px;
            overflow: hidden;
        }

        .event-type {
            font-weight: bold;
            color: #569cd6;
            white-space: nowrap;
        }

        .event-text {
            color: #ce9178;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-params {
            color: #808080;
            font-size: 11px;
            white-space: nowrap;
        }

        /* Î∏îÎ°ù ÌÉÄÏûÖÎ≥Ñ ÏÉâÏÉÅ */
        .event-block[data-type="dialogue"] .event-icon { color: #569cd6; }
        .event-block[data-type="choice"] .event-icon { color: #dcdcaa; }
        .event-block[data-type="choice-branch"] .event-icon { color: #c586c0; }
        .event-block[data-type="condition"] .event-icon { color: #4ec9b0; }
        .event-block[data-type="bgm"] .event-icon { color: #c586c0; }
        .event-block[data-type="sfx"] .event-icon { color: #4fc1ff; }
        .event-block[data-type="label"] .event-icon { color: #dcdcaa; }
        .event-block[data-type="jump"] .event-icon { color: #c586c0; }
        .event-block[data-type="background"] .event-icon { color: #4ec9b0; }
        .event-block[data-type="character"] .event-icon { color: #9cdcfe; }
        .event-block[data-type="comment"] .event-icon { color: #6a9955; }

        .event-block.empty {
            color: #555;
        }

        /* Ïò§Î•∏Ï™Ω Ìå®ÎÑê */
        .right-panel {
            background: #252526;
            border-left: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        /* ÌÉ≠ ÏòÅÏó≠ */
        .right-tabs {
            display: flex;
            background: #2d2d30;
            border-bottom: 1px solid #3c3c3c;
        }

        .right-tab {
            flex: 1;
            padding: 6px;
            text-align: center;
            font-size: 11px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #888;
        }

        .right-tab:hover {
            color: #ccc;
        }

        .right-tab.active {
            color: #fff;
            border-bottom-color: #0078d4;
        }

        .right-content {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }

        .right-content.active {
            display: flex;
        }

        /* Î™ÖÎ†πÏñ¥ ÌåîÎ†àÌä∏ */
        .command-search {
            padding: 8px;
            border-bottom: 1px solid #333;
        }

        .command-categories {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }

        .command-category {
            border-bottom: 1px solid #333;
        }

        .category-header {
            padding: 6px 10px;
            background: #2d2d30;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #888;
        }

        .category-header:hover {
            background: #333;
            color: #ccc;
        }

        .category-header .arrow {
            transition: transform 0.2s;
            font-size: 10px;
        }

        .category-header.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .command-list {
            padding: 4px;
        }

        .command-list.hidden {
            display: none;
        }

        .command-item {
            padding: 5px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .command-item:hover {
            background: #37373d;
        }

        .command-item .cmd-icon {
            width: 18px;
            text-align: center;
        }

        .command-item .cmd-shortcut {
            margin-left: auto;
            color: #666;
            font-size: 10px;
        }

        /* ÎØ∏Î¶¨Î≥¥Í∏∞ Ìå®ÎÑê */
        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
        }

        .preview-frame {
            flex: 1;
            margin: 10px;
            background: linear-gradient(180deg, #0a0a15 0%, #1a1a2e 50%, #0f0f20 100%);
            border-radius: 8px;
            border: 1px solid #333;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .preview-header {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.5);
            font-size: 11px;
            color: #888;
            display: flex;
            justify-content: space-between;
        }

        .preview-bg {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 15px;
            background-size: cover;
            background-position: center;
        }

        .preview-character {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
        }

        .preview-textbox {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 12px;
        }

        .preview-speaker {
            font-size: 11px;
            color: #569cd6;
            margin-bottom: 6px;
        }

        .preview-text {
            font-size: 12px;
            line-height: 1.6;
            color: #e0e0e0;
            min-height: 40px;
        }

        .preview-choices {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .preview-choice {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
        }

        .preview-choice.nod {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid rgba(78, 205, 196, 0.4);
            color: #4ecdc4;
        }

        .preview-choice.shake {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
        }

        /* ÌîåÎ°úÏö∞Ï∞®Ìä∏ */
        .flowchart-panel {
            flex: 1;
            padding: 10px;
            overflow: auto;
        }

        .flowchart-minimap {
            background: #1e1e1e;
            border-radius: 4px;
            padding: 10px;
            min-height: 200px;
        }

        .flow-node {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }

        .flow-node.dialogue { background: #264f78; }
        .flow-node.choice { background: #4d4d00; }
        .flow-node.condition { background: #3b6e4b; }
        .flow-node.label { background: #6e5a3b; }
        .flow-node.active { box-shadow: 0 0 0 2px #fff; }

        /* ÌïòÎã® ÏÉÅÌÉúÎ∞î */
        .statusbar {
            grid-column: 1 / -1;
            background: #007acc;
            padding: 0 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 11px;
            color: #fff;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-item.error {
            background: #c42b1c;
            padding: 0 8px;
            margin: 0 -10px;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .status-right {
            margin-left: auto;
            display: flex;
            gap: 15px;
        }

        /* Î™®Îã¨ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #2d2d30;
            border: 1px solid #454545;
            border-radius: 6px;
            min-width: 400px;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 12px 15px;
            background: #3c3c3c;
            border-bottom: 1px solid #454545;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 6px 6px 0 0;
        }

        .modal-body {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 10px 15px;
            background: #2d2d30;
            border-top: 1px solid #454545;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            border-radius: 0 0 6px 6px;
        }

        .modal-btn {
            padding: 6px 16px;
            font-size: 12px;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .modal-btn.primary {
            background: #0078d4;
            color: #fff;
        }

        .modal-btn.primary:hover {
            background: #1a85dc;
        }

        .modal-btn.cancel {
            background: #3c3c3c;
            border-color: #555;
            color: #ccc;
        }

        .modal-btn.cancel:hover {
            background: #454545;
        }

        /* Ìèº ÏöîÏÜå */
        .form-row {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 6px 10px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 3px;
            color: #e0e0e0;
            font-size: 12px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #0078d4;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-grid.three {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-hint {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }

        /* Ï≤¥ÌÅ¨Î∞ïÏä§/ÎùºÎîîÏò§ */
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .checkbox-row input {
            width: 14px;
            height: 14px;
        }

        .checkbox-row label {
            font-size: 12px;
            cursor: pointer;
        }

        /* Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ */
        .context-menu {
            position: fixed;
            background: #2d2d30;
            border: 1px solid #454545;
            border-radius: 4px;
            padding: 4px 0;
            min-width: 200px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-item {
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-item:hover {
            background: #094771;
        }

        .context-item.disabled {
            color: #555;
            pointer-events: none;
        }

        .context-item.danger {
            color: #f48771;
        }

        .context-divider {
            height: 1px;
            background: #454545;
            margin: 4px 0;
        }

        .context-item .shortcut {
            margin-left: auto;
            color: #666;
            font-size: 10px;
        }

        /* ÌÜ†Ïä§Ìä∏ */
        .toast-container {
            position: fixed;
            bottom: 40px;
            right: 20px;
            z-index: 3000;
        }

        .toast {
            background: #323232;
            color: #fff;
            padding: 10px 16px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: toastIn 0.2s ease;
        }

        .toast.success {
            border-left: 3px solid #4ec9b0;
        }

        .toast.error {
            border-left: 3px solid #f48771;
        }

        .toast.warning {
            border-left: 3px solid #dcdcaa;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ïä§ÌÅ¨Î°§Î∞î */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Ïà®ÍπÄ ÌååÏùº ÏûÖÎ†• */
        .hidden-input {
            display: none;
        }

        /* Ìà¥ÌåÅ */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: #1e1e1e;
            border: 1px solid #454545;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
        }

        /* ÎìúÎûòÍ∑∏ Ïò§Î≤Ñ */
        .event-block.drag-over {
            border-top: 2px solid #0078d4;
        }

        /* ÎπÑÌôúÏÑ±Ìôî Î∏îÎ°ù */
        .event-block.disabled {
            opacity: 0.5;
        }

        .event-block.disabled .event-content {
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Î©îÎâ¥Î∞î -->
        <div class="menubar">
            <div class="menu-group">
                <button class="menu-btn" onclick="newProject()" data-tooltip="ÏÉà ÌîÑÎ°úÏ†ùÌä∏">ÏÉàÎ°ú</button>
                <button class="menu-btn" onclick="importJSON()" data-tooltip="Ïó¥Í∏∞">Ïó¥Í∏∞</button>
                <button class="menu-btn" onclick="exportJSON()" data-tooltip="Ï†ÄÏû•">Ï†ÄÏû•</button>
            </div>
            <div class="menu-group">
                <button class="menu-btn" onclick="undo()" data-tooltip="Ïã§ÌñâÏ∑®ÏÜå (Ctrl+Z)">‚Ü∂</button>
                <button class="menu-btn" onclick="redo()" data-tooltip="Îã§ÏãúÏã§Ìñâ (Ctrl+Y)">‚Ü∑</button>
            </div>
            <div class="menu-group">
                <button class="menu-btn" onclick="copySelected()" data-tooltip="Î≥µÏÇ¨ (Ctrl+C)">Î≥µÏÇ¨</button>
                <button class="menu-btn" onclick="cutSelected()" data-tooltip="ÏûòÎùºÎÇ¥Í∏∞ (Ctrl+X)">ÏûòÎùº</button>
                <button class="menu-btn" onclick="pasteCommand()" data-tooltip="Î∂ôÏó¨ÎÑ£Í∏∞ (Ctrl+V)">Î∂ôÏó¨</button>
            </div>
            <div class="menu-group">
                <button class="menu-btn" onclick="showFindReplace()" data-tooltip="Ï∞æÍ∏∞/Î∞îÍæ∏Í∏∞ (Ctrl+F)">Ï∞æÍ∏∞</button>
                <button class="menu-btn" onclick="toggleBookmark()" data-tooltip="Î∂ÅÎßàÌÅ¨ ÌÜ†Í∏Ä (Ctrl+B)">‚òÖ</button>
                <button class="menu-btn" onclick="jumpToBookmark()" data-tooltip="Îã§Ïùå Î∂ÅÎßàÌÅ¨Î°ú Ïù¥Îèô">‚Üí‚òÖ</button>
            </div>
            <div class="menu-group">
                <button class="menu-btn" onclick="validateScript()" data-tooltip="Ïä§ÌÅ¨Î¶ΩÌä∏ Í≤ÄÏÇ¨">Í≤ÄÏÇ¨</button>
                <button class="menu-btn" onclick="showStats()" data-tooltip="ÌÜµÍ≥Ñ">ÌÜµÍ≥Ñ</button>
            </div>
            <span class="menu-title">
                <span class="auto-save-indicator" id="autoSaveIndicator">‚óè ÏûêÎèô Ï†ÄÏû•Îê®</span>
                Îã¨Ïùò ÏÑ∏Í≥Ñ - ÏãúÎÇòÎ¶¨Ïò§ ÏóêÎîîÌÑ∞
            </span>
        </div>

        <!-- ÏôºÏ™Ω Ìå®ÎÑê -->
        <div class="left-panel">
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="switchLeftTab('days', event)">Day</div>
                <div class="panel-tab" onclick="switchLeftTab('chars', event)">Ï∫êÎ¶≠ÌÑ∞</div>
                <div class="panel-tab" onclick="switchLeftTab('vars', event)">Î≥ÄÏàò</div>
                <div class="panel-tab" onclick="switchLeftTab('assets', event)">ÏóêÏÖã</div>
            </div>

            <!-- Day Î¶¨Ïä§Ìä∏ -->
            <div class="panel-content active" id="panelDays">
                <div class="sub-tabs" style="display: flex; border-bottom: 1px solid #3c3c3c; margin-bottom: 8px;">
                    <div class="sub-tab active" id="subTabDay" onclick="switchDayMode('day')" 
                         style="flex: 1; padding: 6px; text-align: center; cursor: pointer; font-size: 11px; background: #2d2d30;">Day</div>
                    <div class="sub-tab" id="subTabCommon" onclick="switchDayMode('common')"
                         style="flex: 1; padding: 6px; text-align: center; cursor: pointer; font-size: 11px; background: #1e1e1e; color: #888;">Ïª§Î®º</div>
                </div>
                <div id="dayList"></div>
                <div id="commonList" style="display: none;"></div>
                <button class="add-char-btn" id="addDayBtn" onclick="addDay()">+ Day Ï∂îÍ∞Ä</button>
                <button class="add-char-btn" id="addCommonBtn" onclick="addCommon()" style="display: none;">+ Ïª§Î®º Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä</button>
            </div>

            <!-- Ï∫êÎ¶≠ÌÑ∞ Î¶¨Ïä§Ìä∏ -->
            <div class="panel-content" id="panelChars">
                <div id="charList"></div>
                <button class="add-char-btn" onclick="addCharacter()">+ Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä</button>
            </div>

            <!-- Î≥ÄÏàò Ìå®ÎÑê -->
            <div class="panel-content" id="panelVars">
                <div class="var-section">
                    <div class="var-section-title">ÏÇ¨Ïö©Îêú Î≥ÄÏàò</div>
                    <div id="usedVarsList" style="color: #888; font-size: 11px; padding: 8px;">
                        ÏãúÎÇòÎ¶¨Ïò§ÏóêÏÑú ÏÇ¨Ïö©Îêú Î≥ÄÏàòÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.
                    </div>
                </div>
                <div class="var-section">
                    <div class="var-section-title">ÏãúÏä§ÌÖú</div>
                    <div class="var-item">
                        <span class="var-name">ÌòÑÏû¨ Day</span>
                        <span class="var-value" id="varCurrentDay">1</span>
                    </div>
                </div>
            </div>

            <!-- ÏóêÏÖã Ìå®ÎÑê -->
            <div class="panel-content" id="panelAssets">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="ÏóêÏÖã Í≤ÄÏÉâ..." oninput="filterAssets(this.value)">
                </div>
                <div id="assetCategories">
                    <div class="asset-category">
                        <div class="asset-category-header" onclick="toggleAssetCategory(this)">
                            <span>‚ñº</span> Î∞∞Í≤Ω
                            <button class="asset-add-btn" onclick="event.stopPropagation(); addAsset('backgrounds')" title="Î∞∞Í≤Ω Ï∂îÍ∞Ä">+</button>
                        </div>
                        <div class="asset-list" id="assetBg"></div>
                    </div>
                    <div class="asset-category">
                        <div class="asset-category-header" onclick="toggleAssetCategory(this)">
                            <span>‚ñº</span> Ï∫êÎ¶≠ÌÑ∞
                            <button class="asset-add-btn" onclick="event.stopPropagation(); addAsset('characters')" title="Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä">+</button>
                        </div>
                        <div class="asset-list" id="assetChar"></div>
                    </div>
                    <div class="asset-category">
                        <div class="asset-category-header" onclick="toggleAssetCategory(this)">
                            <span>‚ñº</span> BGM
                            <button class="asset-add-btn" onclick="event.stopPropagation(); addAsset('bgm')" title="BGM Ï∂îÍ∞Ä">+</button>
                        </div>
                        <div class="asset-list" id="assetBgm"></div>
                    </div>
                    <div class="asset-category">
                        <div class="asset-category-header" onclick="toggleAssetCategory(this)">
                            <span>‚ñº</span> Ìö®Í≥ºÏùå
                            <button class="asset-add-btn" onclick="event.stopPropagation(); addAsset('sfx')" title="Ìö®Í≥ºÏùå Ï∂îÍ∞Ä">+</button>
                        </div>
                        <div class="asset-list" id="assetSfx"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ï§ëÏïô Ìå®ÎÑê -->
        <div class="center-panel">
            <div class="event-toolbar">
                <button class="toolbar-btn" onclick="insertCommand()">+ Ï∂îÍ∞Ä</button>
                <button class="toolbar-btn" onclick="editSelected()">Ìé∏Ïßë</button>
                <button class="toolbar-btn" onclick="deleteSelected()">ÏÇ≠Ï†ú</button>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn" onclick="moveUp()">‚ñ≤</button>
                <button class="toolbar-btn" onclick="moveDown()">‚ñº</button>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn" onclick="foldAll()">Î™®Îëê Ï†ëÍ∏∞</button>
                <button class="toolbar-btn" onclick="unfoldAll()">Î™®Îëê ÌéºÏπòÍ∏∞</button>

                <div class="toolbar-search">
                    <input type="text" id="quickSearch" placeholder="Îπ†Î•∏ Í≤ÄÏÉâ..." oninput="quickSearch(this.value)">
                    <span id="searchCount" style="color: #888; font-size: 11px;"></span>
                </div>
            </div>

            <div class="event-list-container">
                <div class="event-list" id="eventList"></div>
            </div>
        </div>

        <!-- Ïò§Î•∏Ï™Ω Ìå®ÎÑê -->
        <div class="right-panel">
            <div class="right-tabs">
                <div class="right-tab active" onclick="switchRightTab('commands', event)">Î™ÖÎ†πÏñ¥</div>
                <div class="right-tab" onclick="switchRightTab('preview', event)">ÎØ∏Î¶¨Î≥¥Í∏∞</div>
                <div class="right-tab" onclick="switchRightTab('flow', event)">ÌîåÎ°úÏö∞</div>
            </div>

            <!-- Î™ÖÎ†πÏñ¥ ÌåîÎ†àÌä∏ -->
            <div class="right-content active" id="tabCommands">
                <div class="command-search">
                    <input type="text" class="search-input" placeholder="Î™ÖÎ†πÏñ¥ Í≤ÄÏÉâ..." id="cmdSearch" oninput="filterCommands(this.value)">
                </div>
                <div class="command-categories" id="commandList"></div>
            </div>

            <!-- ÎØ∏Î¶¨Î≥¥Í∏∞ -->
            <div class="right-content" id="tabPreview">
                <div class="preview-panel">
                    <div class="preview-frame">
                        <div class="preview-header">
                            <span id="previewDay">Day 1</span>
                            <span id="previewLabel"></span>
                        </div>
                        <div class="preview-bg" id="previewBg">
                            <div class="preview-character" id="previewChar"></div>
                            <div class="preview-textbox">
                                <div class="preview-speaker" id="previewSpeaker">Ïù∏Ïô∏</div>
                                <div class="preview-text" id="previewText">ÎåÄÏÇ¨Î•º ÏÑ†ÌÉùÌïòÎ©¥ ÎØ∏Î¶¨Î≥¥Í∏∞Í∞Ä ÌëúÏãúÎê©ÎãàÎã§.</div>
                                <div class="preview-choices" id="previewChoices"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÌîåÎ°úÏö∞Ï∞®Ìä∏ -->
            <div class="right-content" id="tabFlow">
                <div class="flowchart-panel">
                    <div class="flowchart-minimap" id="flowchart"></div>
                </div>
            </div>
        </div>

        <!-- ÏÉÅÌÉúÎ∞î -->
        <div class="statusbar">
            <div class="status-item" id="statusErrors" style="display: none;">
                <span>‚ö†Ô∏è</span>
                <span id="errorCount">0</span> Ïò§Î•ò
            </div>
            <div class="status-item">
                <span>üìÖ</span>
                <span id="statusDay">Day 1</span>
            </div>
            <div class="status-item">
                <span>üìù</span>
                <span id="statusEventCount">0</span> Ïù¥Î≤§Ìä∏
            </div>
            <div class="status-item">
                <span>üìç</span>
                <span id="statusLine">-</span>
            </div>
            <div class="status-right">
                <div class="status-item">
                    <span id="statusSelection">ÏÑ†ÌÉù ÏóÜÏùå</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ -->
    <div class="context-menu" id="contextMenu">
        <div class="context-item" onclick="editSelected()">Ìé∏Ïßë <span class="shortcut">Enter</span></div>
        <div class="context-divider"></div>
        <div class="context-item" onclick="copySelected()">Î≥µÏÇ¨ <span class="shortcut">Ctrl+C</span></div>
        <div class="context-item" onclick="cutSelected()">ÏûòÎùºÎÇ¥Í∏∞ <span class="shortcut">Ctrl+X</span></div>
        <div class="context-item" onclick="pasteCommand()">Î∂ôÏó¨ÎÑ£Í∏∞ <span class="shortcut">Ctrl+V</span></div>
        <div class="context-item" onclick="duplicateSelected()">Î≥µÏ†ú <span class="shortcut">Ctrl+D</span></div>
        <div class="context-divider"></div>
        <div class="context-item" onclick="toggleBookmark()">Î∂ÅÎßàÌÅ¨ ÌÜ†Í∏Ä <span class="shortcut">Ctrl+B</span></div>
        <div class="context-item" onclick="toggleDisable()">ÎπÑÌôúÏÑ±Ìôî ÌÜ†Í∏Ä</div>
        <div class="context-divider"></div>
        <div class="context-item" onclick="insertAbove()">ÏúÑÏóê Ï∂îÍ∞Ä</div>
        <div class="context-item" onclick="insertBelow()">ÏïÑÎûòÏóê Ï∂îÍ∞Ä</div>
        <div class="context-divider"></div>
        <div class="context-item danger" onclick="deleteSelected()">ÏÇ≠Ï†ú <span class="shortcut">Del</span></div>
    </div>

    <!-- Î™®Îã¨ -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
        <div class="modal" id="modal" onclick="event.stopPropagation()"></div>
    </div>

    <!-- ÌÜ†Ïä§Ìä∏ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Ïà®Í≤®ÏßÑ ÌååÏùº ÏûÖÎ†• -->
    <input type="file" id="fileInput" accept=".json" class="hidden-input">

    <script>
        // ===== ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ =====
        let project = {
            config: {
                title: "Îã¨Ïùò ÏÑ∏Í≥Ñ",
                version: "1.0"
            },
            characters: [
                { id: 'inhui', name: 'Ïù∏Ïô∏', color: '#569cd6', image: '' },
                { id: 'narration', name: 'ÎÇòÎ†àÏù¥ÏÖò', color: '#888888', image: '' }
            ],
            assets: {
                backgrounds: [],
                characters: [],
                bgm: [],
                sfx: []
            },
            dayList: [
                { id: 'day1', name: '1ÏùºÏ∞®' },
                { id: 'day2', name: '2ÏùºÏ∞®' },
                { id: 'day3', name: '3ÏùºÏ∞®' },
                { id: 'day4', name: '4ÏùºÏ∞®' },
                { id: 'day5', name: '5ÏùºÏ∞®' },
                { id: 'day6', name: '6ÏùºÏ∞®' },
                { id: 'day7', name: '7ÏùºÏ∞®' }
            ],
            days: { day1: [], day2: [], day3: [], day4: [], day5: [], day6: [], day7: [] },
            commonList: [],
            commons: {},
            bookmarks: []
        };

        let currentDay = 'day1';
        let currentMode = 'day'; // 'day' ÎòêÎäî 'common'
        let selectedIndex = -1;
        let selectedIndices = []; // Îã§Ï§ë ÏÑ†ÌÉù
        let clipboard = [];
        let undoHistory = [];
        let historyIndex = -1;
        let searchMatches = [];
        let foldedBlocks = new Set();
        let autoSaveTimer = null;

        // ===== Î™ÖÎ†πÏñ¥ Ï†ïÏùò =====
        const COMMANDS = {
            message: {
                name: 'Î©îÏãúÏßÄ',
                items: [
                    { type: 'dialogue', name: 'ÎåÄÏÇ¨ ÌëúÏãú', icon: '‚ñ∑', shortcut: 'D' },
                    { type: 'choice', name: 'ÏÑ†ÌÉùÏßÄ Î∏îÎ°ù', icon: '‚óá', shortcut: 'C' },
                    { type: 'text-speed', name: 'ÌÖçÏä§Ìä∏ ÏÜçÎèÑ', icon: '¬ª' },
                    { type: 'text-color', name: 'ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ', icon: '‚ñ£' },
                ]
            },
            flow: {
                name: 'ÌùêÎ¶Ñ Ï†úÏñ¥',
                items: [
                    { type: 'condition', name: 'Ï°∞Í±¥ Î∂ÑÍ∏∞', icon: '?' },
                    { type: 'label', name: 'ÎùºÎ≤®', icon: '#', shortcut: 'L' },
                    { type: 'jump', name: 'ÎùºÎ≤®Î°ú Ïù¥Îèô', icon: '‚Üí', shortcut: 'J' },
                    { type: 'call-common', name: 'Ïª§Î®º Ïù¥Î≤§Ìä∏ Ìò∏Ï∂ú', icon: '‚óà' },
                    { type: 'jump-day', name: 'Day Ïù¥Îèô', icon: '‚ñ∂' },
                    { type: 'ending', name: 'ÏóîÎî©', icon: '‚ñ†' },
                    { type: 'return', name: 'Î≥µÍ∑Ä', icon: '‚Üê' },
                ]
            },
            variable: {
                name: 'Î≥ÄÏàò',
                items: [
                    { type: 'variable', name: 'Î≥ÄÏàò Ï°∞Ïûë', icon: '$', shortcut: 'V' },
                    { type: 'variable-show', name: 'Î≥ÄÏàò ÌëúÏãú', icon: '‚óé' },
                ]
            },
            display: {
                name: 'ÌôîÎ©¥ ÌëúÏãú',
                items: [
                    { type: 'background', name: 'Î∞∞Í≤Ω Î≥ÄÍ≤Ω', icon: '‚ñ¢', shortcut: 'B' },
                    { type: 'character', name: 'Ï∫êÎ¶≠ÌÑ∞ ÌëúÏãú', icon: '‚óã' },
                    { type: 'character-hide', name: 'Ï∫êÎ¶≠ÌÑ∞ Ïà®Í∏∞Í∏∞', icon: '‚óè' },
                    { type: 'character-move', name: 'Ï∫êÎ¶≠ÌÑ∞ Ïù¥Îèô', icon: '‚áÑ' },
                    { type: 'expression', name: 'ÌëúÏ†ï Î≥ÄÍ≤Ω', icon: '‚óî' },
                ]
            },
            audio: {
                name: 'Ïò§ÎîîÏò§',
                items: [
                    { type: 'bgm', name: 'BGM Ïû¨ÏÉù', icon: '‚ô™', shortcut: 'M' },
                    { type: 'bgm-stop', name: 'BGM Ï†ïÏßÄ', icon: '‚ñ°' },
                    { type: 'bgm-fade', name: 'BGM ÌéòÏù¥Îìú', icon: '~' },
                    { type: 'sfx', name: 'Ìö®Í≥ºÏùå Ïû¨ÏÉù', icon: '‚ô´', shortcut: 'S' },
                    { type: 'voice', name: 'ÏùåÏÑ± Ïû¨ÏÉù', icon: '‚óÅ' },
                ]
            },
            effect: {
                name: 'Ïó∞Ï∂ú',
                items: [
                    { type: 'day-transition', name: 'ÌïòÎ£® Ï†ÑÌôò', icon: '‚òÄ' },
                    { type: 'fade-black', name: 'ÏïîÏ†Ñ', icon: '‚ñì' },
                    { type: 'fade-in', name: 'ÌéòÏù¥ÎìúÏù∏', icon: '‚ñë' },
                    { type: 'fade-white', name: 'ÌôîÏù¥Ìä∏ÏïÑÏõÉ', icon: '‚ñí' },
                    { type: 'screen-shake', name: 'ÌôîÎ©¥ ÌùîÎì§Î¶º', icon: '‚âã' },
                    { type: 'flash', name: 'ÌôîÎ©¥ ÌîåÎûòÏãú', icon: '‚ú¶' },
                    { type: 'tint', name: 'ÌôîÎ©¥ Ìã¥Ìä∏', icon: '‚óê' },
                    { type: 'wait', name: 'ÎåÄÍ∏∞', icon: '‚Ä¶', shortcut: 'W' },
                ]
            },
            etc: {
                name: 'Í∏∞ÌÉÄ',
                items: [
                    { type: 'comment', name: 'Ï£ºÏÑù', icon: '//' },
                    { type: 'plugin', name: 'ÌîåÎü¨Í∑∏Ïù∏ Ìò∏Ï∂ú', icon: '‚öô' },
                    { type: 'script', name: 'Ïä§ÌÅ¨Î¶ΩÌä∏', icon: '{}' },
                ]
            }
        };

        // ===== Ï¥àÍ∏∞Ìôî =====
        function init() {
            renderDayList();
            renderCharList();
            renderEventList();
            renderCommandList();
            renderAssets();
            updateStatus();
            setupEventListeners();
            loadAutoSave();
        }

        function setupEventListeners() {
            // ÌååÏùº ÏûÖÎ†•
            document.getElementById('fileInput').addEventListener('change', handleFileImport);

            // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
            document.addEventListener('keydown', handleKeyboard);

            // ÌÅ¥Î¶≠ÏúºÎ°ú Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ Îã´Í∏∞
            document.addEventListener('click', () => {
                document.getElementById('contextMenu').classList.remove('active');
            });

            // ÏûêÎèô Ï†ÄÏû•
            setInterval(autoSave, 30000); // 30Ï¥àÎßàÎã§
        }

        function handleKeyboard(e) {
            // ÏûÖÎ†• ÌïÑÎìúÏóêÏÑúÎäî Îã®Ï∂ïÌÇ§ Î¨¥Ïãú
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Escape') e.target.blur();
                return;
            }

            // Ctrl Ï°∞Ìï©
            if (e.ctrlKey || e.metaKey) {
                switch (e.key.toLowerCase()) {
                    case 'z': e.preventDefault(); undo(); break;
                    case 'y': e.preventDefault(); redo(); break;
                    case 'c': e.preventDefault(); copySelected(); break;
                    case 'x': e.preventDefault(); cutSelected(); break;
                    case 'v': e.preventDefault(); pasteCommand(); break;
                    case 'd': e.preventDefault(); duplicateSelected(); break;
                    case 'f': e.preventDefault(); showFindReplace(); break;
                    case 'b': e.preventDefault(); toggleBookmark(); break;
                    case 's': e.preventDefault(); exportJSON(); break;
                    case 'a': e.preventDefault(); selectAll(); break;
                }
                return;
            }

            // ÏùºÎ∞ò ÌÇ§
            switch (e.key) {
                case 'Delete': deleteSelected(); break;
                case 'Enter': editSelected(); break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (selectedIndex > 0) {
                        if (e.shiftKey) {
                            // Shift+ÏúÑ: Î≤îÏúÑ ÌôïÏû•
                            const newIndex = selectedIndex - 1;
                            if (!selectedIndices.includes(newIndex)) {
                                selectedIndices.push(newIndex);
                                selectedIndices.sort((a, b) => a - b);
                            }
                            selectedIndex = newIndex;
                        } else {
                            selectedIndex--;
                            selectedIndices = [selectedIndex];
                        }
                        renderEventList();
                        updatePreview();
                        scrollToSelected();
                    }
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    if (selectedIndex < getCurrentEvents().length - 1) {
                        if (e.shiftKey) {
                            // Shift+ÏïÑÎûò: Î≤îÏúÑ ÌôïÏû•
                            const newIndex = selectedIndex + 1;
                            if (!selectedIndices.includes(newIndex)) {
                                selectedIndices.push(newIndex);
                                selectedIndices.sort((a, b) => a - b);
                            }
                            selectedIndex = newIndex;
                        } else {
                            selectedIndex++;
                            selectedIndices = [selectedIndex];
                        }
                        renderEventList();
                        updatePreview();
                        scrollToSelected();
                    }
                    break;
                case 'Escape':
                    closeModal();
                    clearSelection();
                    renderEventList();
                    break;
            }
        }
        
        function scrollToSelected() {
            const selected = document.querySelector('.event-block.selected');
            if (selected) {
                selected.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }

        // ===== ÏôºÏ™Ω Ìå®ÎÑê ÌÉ≠ =====
        function switchLeftTab(tab, e) {
            document.querySelectorAll('.left-panel .panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.left-panel .panel-content').forEach(c => c.classList.remove('active'));
            
            e.target.classList.add('active');
            document.getElementById(`panel${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
        }

        // ===== Ïò§Î•∏Ï™Ω Ìå®ÎÑê ÌÉ≠ =====
        function switchRightTab(tab, e) {
            document.querySelectorAll('.right-panel .right-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.right-panel .right-content').forEach(c => c.classList.remove('active'));
            
            e.target.classList.add('active');
            document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            
            if (tab === 'preview') updatePreview();
            if (tab === 'flow') updateFlowchart();
        }

        // ===== Day Î¶¨Ïä§Ìä∏ =====
        function renderDayList() {
            const container = document.getElementById('dayList');
            container.innerHTML = '';
            
            project.dayList.forEach((day, index) => {
                const count = (project.days[day.id] || []).length;
                const item = document.createElement('div');
                item.className = `day-item ${day.id === currentDay && currentMode === 'day' ? 'active' : ''}`;
                item.innerHTML = `
                    <span>${day.name}</span>
                    <span class="count">${count}</span>
                    <div class="char-actions" style="margin-left: auto;">
                        <button onclick="event.stopPropagation(); editDay('${day.id}')" title="Ìé∏Ïßë">‚úé</button>
                        ${project.dayList.length > 1 ? `<button onclick="event.stopPropagation(); deleteDay('${day.id}')" title="ÏÇ≠Ï†ú">√ó</button>` : ''}
                    </div>
                `;
                item.onclick = () => selectDay(day.id);
                container.appendChild(item);
            });
        }

        function renderCommonList() {
            const container = document.getElementById('commonList');
            if (!container) return;
            container.innerHTML = '';
            
            if (!project.commonList) project.commonList = [];
            if (!project.commons) project.commons = {};
            
            if (project.commonList.length === 0) {
                container.innerHTML = '<div style="color: #666; padding: 12px; font-size: 11px;">Ïª§Î®º Ïù¥Î≤§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            project.commonList.forEach((common, index) => {
                const count = (project.commons[common.id] || []).length;
                const item = document.createElement('div');
                item.className = `day-item ${common.id === currentDay && currentMode === 'common' ? 'active' : ''}`;
                item.innerHTML = `
                    <span style="color: #dcdcaa;">‚óà ${common.name}</span>
                    <span class="count">${count}</span>
                    <div class="char-actions" style="margin-left: auto;">
                        <button onclick="event.stopPropagation(); editCommon('${common.id}')" title="Ìé∏Ïßë">‚úé</button>
                        <button onclick="event.stopPropagation(); deleteCommon('${common.id}')" title="ÏÇ≠Ï†ú">√ó</button>
                    </div>
                `;
                item.onclick = () => selectCommon(common.id);
                container.appendChild(item);
            });
        }

        function switchDayMode(mode) {
            currentMode = mode;
            
            // ÌÉ≠ Ïä§ÌÉÄÏùº Ï†ÑÌôò
            const dayTab = document.getElementById('subTabDay');
            const commonTab = document.getElementById('subTabCommon');
            const dayList = document.getElementById('dayList');
            const commonList = document.getElementById('commonList');
            const addDayBtn = document.getElementById('addDayBtn');
            const addCommonBtn = document.getElementById('addCommonBtn');
            
            if (mode === 'day') {
                dayTab.style.background = '#2d2d30';
                dayTab.style.color = '#fff';
                commonTab.style.background = '#1e1e1e';
                commonTab.style.color = '#888';
                dayList.style.display = 'block';
                commonList.style.display = 'none';
                addDayBtn.style.display = 'block';
                addCommonBtn.style.display = 'none';
                
                // Ï≤´ Î≤àÏß∏ Day ÏÑ†ÌÉù
                if (project.dayList.length > 0) {
                    selectDay(project.dayList[0].id);
                }
            } else {
                dayTab.style.background = '#1e1e1e';
                dayTab.style.color = '#888';
                commonTab.style.background = '#2d2d30';
                commonTab.style.color = '#fff';
                dayList.style.display = 'none';
                commonList.style.display = 'block';
                addDayBtn.style.display = 'none';
                addCommonBtn.style.display = 'block';
                
                renderCommonList();
                // Ï≤´ Î≤àÏß∏ Ïª§Î®º Ïù¥Î≤§Ìä∏ ÏÑ†ÌÉù
                if (project.commonList && project.commonList.length > 0) {
                    selectCommon(project.commonList[0].id);
                } else {
                    currentDay = null;
                    selectedIndex = -1;
                    selectedIndices = [];
                    renderEventList();
                }
            }
        }

        function selectDay(dayId) {
            currentMode = 'day';
            currentDay = dayId;
            selectedIndex = -1;
            selectedIndices = [];
            renderDayList();
            renderCommonList();
            renderEventList();
            updateStatus();
            updatePreview();
        }

        function selectCommon(commonId) {
            currentMode = 'common';
            currentDay = commonId;
            selectedIndex = -1;
            selectedIndices = [];
            renderDayList();
            renderCommonList();
            renderEventList();
            updateStatus();
            updatePreview();
        }

        // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù∏ Ïù¥Î≤§Ìä∏ Î∞∞Ïó¥ Î∞òÌôò
        function getCurrentEvents() {
            if (currentMode === 'common') {
                if (!project.commons) project.commons = {};
                if (!project.commons[currentDay]) project.commons[currentDay] = [];
                return project.commons[currentDay];
            } else {
                if (!project.days[currentDay]) project.days[currentDay] = [];
                return project.days[currentDay];
            }
        }

        // ===== Ïª§Î®º Ïù¥Î≤§Ìä∏ Í¥ÄÎ¶¨ =====
        function addCommon() {
            const newId = 'common' + Date.now();
            const newNum = (project.commonList || []).length + 1;
            
            showModal(`
                <div class="modal-header">Ïª§Î®º Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-input" id="newCommonName" placeholder="Ïòà: Í≥µÌÜµ ÎåÄÌôî" value="Ïª§Î®º Ïù¥Î≤§Ìä∏ ${newNum}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveNewCommon('${newId}')">Ï∂îÍ∞Ä</button>
                </div>
            `);
        }

        function saveNewCommon(id) {
            const name = document.getElementById('newCommonName').value.trim() || 'Ïª§Î®º Ïù¥Î≤§Ìä∏';
            
            if (!project.commonList) project.commonList = [];
            if (!project.commons) project.commons = {};
            
            project.commonList.push({ id, name });
            project.commons[id] = [];
            
            closeModal();
            renderCommonList();
            selectCommon(id);
            showToast('Ïª§Î®º Ïù¥Î≤§Ìä∏Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
            triggerAutoSave();
        }

        function editCommon(commonId) {
            const common = project.commonList.find(c => c.id === commonId);
            if (!common) return;
            
            showModal(`
                <div class="modal-header">Ïª§Î®º Ïù¥Î≤§Ìä∏ Ìé∏Ïßë</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-input" id="editCommonName" value="${common.name}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveCommonEdit('${commonId}')">Ï†ÄÏû•</button>
                </div>
            `);
        }

        function saveCommonEdit(commonId) {
            const common = project.commonList.find(c => c.id === commonId);
            if (!common) return;
            
            common.name = document.getElementById('editCommonName').value.trim() || 'Ïª§Î®º Ïù¥Î≤§Ìä∏';
            closeModal();
            renderCommonList();
            showToast('Ïª§Î®º Ïù¥Î≤§Ìä∏Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
            triggerAutoSave();
        }

        function deleteCommon(commonId) {
            const common = project.commonList.find(c => c.id === commonId);
            const eventCount = (project.commons[commonId] || []).length;
            
            showConfirmModal(`"${common.name}"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?${eventCount > 0 ? `\n(${eventCount}Í∞úÏùò Ïù¥Î≤§Ìä∏Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§)` : ''}`, () => {
                saveToHistory();
                
                const index = project.commonList.findIndex(c => c.id === commonId);
                project.commonList.splice(index, 1);
                delete project.commons[commonId];
                
                if (currentDay === commonId) {
                    if (project.commonList.length > 0) {
                        selectCommon(project.commonList[0].id);
                    } else {
                        switchDayMode('day');
                    }
                }
                
                renderCommonList();
                showToast('Ïª§Î®º Ïù¥Î≤§Ìä∏Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                triggerAutoSave();
            });
        }

        // ===== Day Í¥ÄÎ¶¨ =====
        function addDay() {
            const newId = 'day' + Date.now();
            const newNum = project.dayList.length + 1;
            
            showModal(`
                <div class="modal-header">Day Ï∂îÍ∞Ä</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Day Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-input" id="newDayName" placeholder="Ïòà: ${newNum}ÏùºÏ∞®" value="${newNum}ÏùºÏ∞®">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveNewDay('${newId}')">Ï∂îÍ∞Ä</button>
                </div>
            `);
        }

        function saveNewDay(newId) {
            const name = document.getElementById('newDayName').value.trim() || 'ÏÉà Day';
            
            saveToHistory();
            project.dayList.push({ id: newId, name: name });
            project.days[newId] = [];
            
            closeModal();
            renderDayList();
            showToast('DayÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
            triggerAutoSave();
        }

        function editDay(dayId) {
            const day = project.dayList.find(d => d.id === dayId);
            if (!day) return;
            
            showModal(`
                <div class="modal-header">Day Ìé∏Ïßë</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Day Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-input" id="editDayName" value="${day.name}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveEditDay('${dayId}')">Ï†ÄÏû•</button>
                </div>
            `);
        }

        function saveEditDay(dayId) {
            const name = document.getElementById('editDayName').value.trim();
            if (!name) {
                showToast('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
                return;
            }
            
            saveToHistory();
            const day = project.dayList.find(d => d.id === dayId);
            if (day) day.name = name;
            
            closeModal();
            renderDayList();
            updateStatus();
            showToast('DayÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
            triggerAutoSave();
        }

        function deleteDay(dayId) {
            if (project.dayList.length <= 1) {
                showToast('ÏµúÏÜå ÌïòÎÇòÏùò DayÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.', 'warning');
                return;
            }
            
            const day = project.dayList.find(d => d.id === dayId);
            const eventCount = (project.days[dayId] || []).length;
            
            showConfirmModal(`"${day.name}"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?${eventCount > 0 ? `\n(${eventCount}Í∞úÏùò Ïù¥Î≤§Ìä∏Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§)` : ''}`, () => {
                saveToHistory();
                
                // dayListÏóêÏÑú Ï†úÍ±∞
                const index = project.dayList.findIndex(d => d.id === dayId);
                project.dayList.splice(index, 1);
                
                // daysÏóêÏÑú Ï†úÍ±∞
                delete project.days[dayId];
                
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú dayÍ∞Ä ÏÇ≠Ï†úÎêòÎ©¥ Ï≤´ Î≤àÏß∏ day ÏÑ†ÌÉù
                if (currentDay === dayId) {
                    currentDay = project.dayList[0].id;
                }
                
                renderDayList();
                renderEventList();
                updateStatus();
                showToast('DayÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                triggerAutoSave();
            });
        }

        // Day IDÎ°ú Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
        function getDayName(dayId) {
            const day = project.dayList.find(d => d.id === dayId);
            return day ? day.name : dayId;
        }

        // ===== Ï∫êÎ¶≠ÌÑ∞ Î¶¨Ïä§Ìä∏ =====
        function renderCharList() {
            const container = document.getElementById('charList');
            container.innerHTML = project.characters.map((char, i) => `
                <div class="char-item">
                    <div class="char-color" style="background: ${char.color}"></div>
                    <span class="char-name">${char.name}</span>
                    <div class="char-actions">
                        <button onclick="editCharacter(${i})">‚úé</button>
                        ${char.id !== 'narration' ? `<button onclick="deleteCharacter(${i})">√ó</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function addCharacter() {
            showModal(`
                <div class="modal-header">Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ï∫êÎ¶≠ÌÑ∞ ID (ÏòÅÎ¨∏)</label>
                        <input type="text" class="form-input" id="charId" placeholder="Ïòà: heroine">
                    </div>
                    <div class="form-row">
                        <label class="form-label">ÌëúÏãú Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-input" id="charName" placeholder="Ïòà: ÌûàÎ°úÏù∏">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Ïù¥Î¶Ñ ÏÉâÏÉÅ</label>
                        <input type="color" class="form-input" id="charColor" value="#9cdcfe" style="height: 36px;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveNewCharacter()">Ï∂îÍ∞Ä</button>
                </div>
            `);
        }

        function saveNewCharacter() {
            const id = document.getElementById('charId').value.trim();
            const name = document.getElementById('charName').value.trim();
            const color = document.getElementById('charColor').value;
            
            if (!id || !name) {
                showToast('IDÏôÄ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
                return;
            }
            
            if (project.characters.find(c => c.id === id)) {
                showToast('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî IDÏûÖÎãàÎã§.', 'error');
                return;
            }
            
            saveToHistory();
            project.characters.push({ id, name, color, image: '' });
            renderCharList();
            closeModal();
            showToast('Ï∫êÎ¶≠ÌÑ∞Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
        }

        function editCharacter(index) {
            const char = project.characters[index];
            showModal(`
                <div class="modal-header">Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ï∫êÎ¶≠ÌÑ∞ ID</label>
                        <input type="text" class="form-input" value="${char.id}" disabled>
                    </div>
                    <div class="form-row">
                        <label class="form-label">ÌëúÏãú Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-input" id="editCharName" value="${char.name}">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Ïù¥Î¶Ñ ÏÉâÏÉÅ</label>
                        <input type="color" class="form-input" id="editCharColor" value="${char.color}" style="height: 36px;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveEditCharacter(${index})">Ï†ÄÏû•</button>
                </div>
            `);
        }

        function saveEditCharacter(index) {
            saveToHistory();
            project.characters[index].name = document.getElementById('editCharName').value;
            project.characters[index].color = document.getElementById('editCharColor').value;
            renderCharList();
            closeModal();
            showToast('Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
        }

        function deleteCharacter(index) {
            showConfirmModal('Ïù¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', () => {
                saveToHistory();
                project.characters.splice(index, 1);
                renderCharList();
            });
        }

        // ===== Î™ÖÎ†πÏñ¥ ÌåîÎ†àÌä∏ =====
        function renderCommandList() {
            const container = document.getElementById('commandList');
            container.innerHTML = Object.entries(COMMANDS).map(([key, cat]) => `
                <div class="command-category">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <span class="arrow">‚ñº</span> ${cat.name}
                    </div>
                    <div class="command-list">
                        ${cat.items.map(cmd => `
                            <div class="command-item" onclick="addCommand('${cmd.type}')">
                                <span class="cmd-icon">${cmd.icon}</span>
                                <span>${cmd.name}</span>
                                ${cmd.shortcut ? `<span class="cmd-shortcut">${cmd.shortcut}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleCategory(header) {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('hidden');
        }

        function filterCommands(query) {
            const q = query.toLowerCase();
            document.querySelectorAll('.command-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(q) ? '' : 'none';
            });
        }

        // ===== Ïù¥Î≤§Ìä∏ Î¶¨Ïä§Ìä∏ =====
        function renderEventList() {
            const container = document.getElementById('eventList');
            const events = getCurrentEvents();
            
            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div class="event-block empty" ondblclick="insertCommand()">
                        <div class="event-line-num">1</div>
                        <div class="event-icon">‚óá</div>
                        <div class="event-content">
                            <span style="color: #555;">ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏó¨ Î™ÖÎ†π Ï∂îÍ∞Ä...</span>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let indentLevel = 0;
            const indentStack = [];
            
            events.forEach((event, index) => {
                // Îì§Ïó¨Ïì∞Í∏∞ Ï°∞Ï†ï
                if (['choice-end', 'condition-end'].includes(event.type)) {
                    indentLevel = Math.max(0, indentLevel - 1);
                    indentStack.pop();
                }
                if (['choice-branch', 'condition-else'].includes(event.type)) {
                    if (indentLevel > 0) indentLevel--;
                }
                
                const isMatch = searchMatches.includes(index);
                const isBookmark = project.bookmarks.includes(`${currentDay}-${index}`);
                const isDisabled = event.disabled;
                const hasError = event._error;
                const isSelected = selectedIndices.includes(index);
                
                let classes = ['event-block'];
                if (isSelected) classes.push('selected');
                if (isMatch) classes.push('search-match');
                if (isBookmark) classes.push('bookmark');
                if (hasError) classes.push('error');
                if (isDisabled) classes.push('disabled');
                
                const indentHtml = '<div class="event-indent"></div>'.repeat(indentLevel);
                
                html += `
                    <div class="${classes.join(' ')}"
                         data-type="${event.type}"
                         data-index="${index}"
                         onclick="selectEvent(${index}, event)"
                         ondblclick="editSelected()"
                         oncontextmenu="showContextMenu(event, ${index})"
                         draggable="true"
                         ondragstart="dragStart(event, ${index})"
                         ondragover="dragOver(event)"
                         ondragleave="dragLeave(event)"
                         ondragend="dragEnd(event)"
                         ondrop="drop(event, ${index})">
                        <div class="event-line-num">${index + 1}</div>
                        ${indentHtml}
                        <div class="event-icon">${getEventIcon(event.type)}</div>
                        <div class="event-content" style="${isDisabled ? 'opacity: 0.5;' : ''}">${getEventDisplayText(event)}</div>
                    </div>
                `;
                
                // Îã§Ïùå Ï§Ñ Îì§Ïó¨Ïì∞Í∏∞
                if (['choice', 'condition'].includes(event.type)) {
                    indentStack.push(event.type);
                    indentLevel++;
                }
                if (['choice-branch', 'condition-else'].includes(event.type)) {
                    indentLevel++;
                }
            });
            
            // ÎßàÏßÄÎßâ Îπà Ï§Ñ
            html += `
                <div class="event-block empty" ondblclick="insertCommand()">
                    <div class="event-line-num">${events.length + 1}</div>
                    <div class="event-icon">‚óá</div>
                    <div class="event-content">
                        <span style="color: #555;">ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏó¨ Î™ÖÎ†π Ï∂îÍ∞Ä...</span>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            updateStatus();
            renderUsedVars();
        }

        function getEventIcon(type) {
            const icons = {
                'dialogue': '‚ñ∑', 'choice': '‚óá', 'choice-branch': '‚óÜ', 'choice-end': '‚óá',
                'condition': '?', 'condition-else': '‚óÜ', 'condition-end': '‚óá',
                'bgm': '‚ô™', 'bgm-stop': '‚ñ°', 'bgm-fade': '~', 'sfx': '‚ô´', 'voice': '‚óÅ',
                'day-transition': '‚òÄ', 'fade-black': '‚ñì', 'fade-in': '‚ñë', 'fade-white': '‚ñí',
                'screen-shake': '‚âã', 'flash': '‚ú¶', 'tint': '‚óê', 'wait': '‚Ä¶',
                'label': '#', 'jump': '‚Üí', 'ending': '‚ñ†', 'return': '‚Üê',
                'call-common': '‚óà', 'jump-day': '‚ñ∂',
                'variable': '$', 'variable-show': '‚óé',
                'background': '‚ñ¢', 'character': '‚óã', 'character-hide': '‚óè',
                'character-move': '‚áÑ', 'expression': '‚óî',
                'text-speed': '¬ª', 'text-color': '‚ñ£',
                'comment': '//', 'plugin': '‚öô', 'script': '{}'
            };
            return icons[type] || '‚óá';
        }

        // ÏÇ¨Ïö©Îêú Î≥ÄÏàò Î™©Î°ù Î†åÎçîÎßÅ
        function renderUsedVars() {
            const vars = getUsedVariables();
            const container = document.getElementById('usedVarsList');
            if (!container) return;
            
            if (vars.length === 0) {
                container.innerHTML = '<div style="color: #666; font-size: 11px;">ÏãúÎÇòÎ¶¨Ïò§ÏóêÏÑú ÏÇ¨Ïö©Îêú Î≥ÄÏàòÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</div>';
            } else {
                container.innerHTML = vars.map(v => `
                    <div class="var-item">
                        <span class="var-name">${v}</span>
                    </div>
                `).join('');
            }
        }

        // Î≥ÄÏàòÎ™ÖÏùÑ ÌëúÏãúÏö© Ïù¥Î¶ÑÏúºÎ°ú Î≥ÄÌôò
        function getVariableDisplayName(varId) {
            return varId || '(ÏóÜÏùå)';
        }

        // ÌîÑÎ°úÏ†ùÌä∏ÏóêÏÑú ÏÇ¨Ïö©Îêú Î™®Îì† Î≥ÄÏàò ÏàòÏßë
        function getUsedVariables() {
            const vars = new Set();
            for (const dayId in project.days) {
                (project.days[dayId] || []).forEach(event => {
                    if (event.variable) vars.add(event.variable);
                    if (event.effects) {
                        Object.keys(event.effects).forEach(v => vars.add(v));
                    }
                });
            }
            return Array.from(vars);
        }

        // Ìö®Í≥º Í∞ùÏ≤¥Î•º Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
        function formatEffects(effects) {
            if (!effects || Object.keys(effects).length === 0) return '(Ìö®Í≥º ÏóÜÏùå)';
            return '(' + Object.entries(effects)
                .filter(([k, v]) => v !== 0)
                .map(([k, v]) => `${getVariableDisplayName(k)} ${v >= 0 ? '+' : ''}${v}`)
                .join(', ') + ')' || '(Ìö®Í≥º ÏóÜÏùå)';
        }

        function getEventDisplayText(event) {
            const charName = (id) => {
                const char = project.characters.find(c => c.id === id);
                return char ? char.name : id;
            };
            
            switch (event.type) {
                case 'dialogue':
                    const speaker = event.speaker === 'narration' ? '' : 
                        `<span class="event-type" style="color: ${project.characters.find(c => c.id === event.speaker)?.color || '#569cd6'}">[${charName(event.speaker)}]</span>`;
                    return `${speaker}<span class="event-text">${event.text || '(Îπà ÎåÄÏÇ¨)'}</span>`;
                
                case 'choice':
                    return `<span class="event-type">ÏÑ†ÌÉùÏßÄ ÌëúÏãú</span>`;
                
                case 'choice-branch':
                    let branchLabel;
                    let branchColor;
                    if (event.choiceType === 'nod') {
                        branchLabel = 'ÎÅÑÎçïÏù∏Îã§';
                        branchColor = '#4ec9b0';
                    } else if (event.choiceType === 'shake') {
                        branchLabel = 'Ï†ìÎäîÎã§';
                        branchColor = '#ce9178';
                    } else {
                        branchLabel = event.label || 'Ïª§Ïä§ÌÖÄ';
                        branchColor = '#dcdcaa';
                    }
                    const effectsStr = formatEffects(event.effects);
                    return `<span class="event-type" style="color: ${branchColor}">‚óÜ ${branchLabel}</span>
                            <span class="event-params">${effectsStr}</span>`;
                
                case 'choice-end':
                case 'condition-end':
                    return `<span style="color: #555">Î∂ÑÍ∏∞ Ï¢ÖÎ£å</span>`;
                
                case 'condition':
                    const condVarName = getVariableDisplayName(event.variable);
                    return `<span class="event-type">Ï°∞Í±¥ Î∂ÑÍ∏∞:</span><span class="event-params">${condVarName} ${event.operator || '>='} ${event.value || 0}</span>`;
                
                case 'condition-else':
                    return `<span class="event-type" style="color: #4ec9b0">‚óÜ Í∑∏ Ïô∏Ïùò Í≤ΩÏö∞</span>`;
                
                case 'background':
                    return `<span class="event-type">Î∞∞Í≤Ω:</span><span class="event-text">${event.file || '(ÏóÜÏùå)'}</span>`;
                
                case 'character':
                    return `<span class="event-type">Ï∫êÎ¶≠ÌÑ∞ ÌëúÏãú:</span><span class="event-text">${charName(event.character)} (${event.position || 'center'})</span>`;
                
                case 'character-hide':
                    return `<span class="event-type">Ï∫êÎ¶≠ÌÑ∞ Ïà®Í∏∞Í∏∞:</span><span class="event-text">${event.character === 'all' ? 'Ï†ÑÏ≤¥' : charName(event.character)}</span>`;
                
                case 'expression':
                    return `<span class="event-type">ÌëúÏ†ï:</span><span class="event-text">${charName(event.character)} ‚Üí ${event.expression || 'Í∏∞Î≥∏'}</span>`;
                
                case 'bgm':
                    return `<span class="event-type">BGM:</span><span class="event-text">${event.file || '(ÏóÜÏùå)'}</span>`;
                
                case 'bgm-stop':
                    return `<span class="event-type">BGM Ï†ïÏßÄ</span>${event.fadeOut ? `<span class="event-params">(${event.fadeOut}ms)</span>` : ''}`;
                
                case 'sfx':
                    return `<span class="event-type">Ìö®Í≥ºÏùå:</span><span class="event-text">${event.file || '(ÏóÜÏùå)'}</span>`;
                
                case 'day-transition':
                    const nextDayName = getDayName(event.nextDay) || 'Îã§Ïùå';
                    return `<span class="event-type">ÌïòÎ£® Ï†ÑÌôò</span><span class="event-params">‚Üí ${nextDayName}</span>`;
                
                case 'fade-black':
                    return `<span class="event-type">ÏïîÏ†Ñ</span><span class="event-params">(${event.duration || 1000}ms)</span>`;
                
                case 'fade-in':
                    return `<span class="event-type">ÌéòÏù¥ÎìúÏù∏</span><span class="event-params">(${event.duration || 1000}ms)</span>`;
                
                case 'screen-shake':
                    return `<span class="event-type">ÌôîÎ©¥ ÌùîÎì§Î¶º</span><span class="event-params">(${event.power || 5}, ${event.duration || 500}ms)</span>`;
                
                case 'wait':
                    return `<span class="event-type">ÎåÄÍ∏∞</span><span class="event-params">${event.frames || 60}ÌîÑÎ†àÏûÑ</span>`;
                
                case 'label':
                    return `<span class="event-type" style="color: #dcdcaa">ÎùºÎ≤®: ${event.name || '(ÏóÜÏùå)'}</span>`;
                
                case 'jump':
                    return `<span class="event-type">Ïù¥Îèô:</span><span class="event-text">${event.target || '(ÏóÜÏùå)'}</span>`;
                
                case 'ending':
                    return `<span class="event-type" style="color: #c586c0">ÏóîÎî©: ${event.endingId || '(ÏóÜÏùå)'}</span>`;
                
                case 'variable':
                    const varDisplayName = getVariableDisplayName(event.variable);
                    const op = { add: '+=', sub: '-=', set: '=' }[event.operation] || '+=';
                    return `<span class="event-type">Î≥ÄÏàò:</span><span class="event-params">${varDisplayName} ${op} ${event.value || 0}</span>`;
                
                case 'comment':
                    return `<span style="color: #6a9955; font-style: italic;">// ${event.text || ''}</span>`;
                
                case 'text-speed':
                    return `<span class="event-type">ÌÖçÏä§Ìä∏ ÏÜçÎèÑ:</span><span class="event-params">${event.speed || 'normal'}</span>`;
                
                case 'text-color':
                    return `<span class="event-type">ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ:</span><span class="event-params" style="color: ${event.color}">${event.color}</span>`;
                
                case 'call-common':
                    const commonName = project.commonList?.find(c => c.id === event.commonId)?.name || '(ÏóÜÏùå)';
                    return `<span class="event-type" style="color: #dcdcaa">Ïª§Î®º Ìò∏Ï∂ú:</span><span class="event-text">${commonName}</span>`;
                
                case 'jump-day':
                    const jumpDayName = getDayName(event.dayId) || '(ÏóÜÏùå)';
                    const labelInfo = event.label ? ` ‚Üí ${event.label}` : '';
                    return `<span class="event-type" style="color: #4ec9b0">Day Ïù¥Îèô:</span><span class="event-text">${jumpDayName}${labelInfo}</span>`;
                
                case 'return':
                    return `<span class="event-type" style="color: #c586c0">Î≥µÍ∑Ä</span>`;
                
                default:
                    return `<span class="event-type">${event.type}</span>`;
            }
        }

        // ===== Ïù¥Î≤§Ìä∏ ÏÑ†ÌÉù =====
        function selectEvent(index, e) {
            if (e && e.shiftKey && selectedIndex >= 0) {
                // Shift+ÌÅ¥Î¶≠: Î≤îÏúÑ ÏÑ†ÌÉù
                const start = Math.min(selectedIndex, index);
                const end = Math.max(selectedIndex, index);
                selectedIndices = [];
                for (let i = start; i <= end; i++) {
                    selectedIndices.push(i);
                }
            } else if (e && (e.ctrlKey || e.metaKey)) {
                // Ctrl+ÌÅ¥Î¶≠: ÌÜ†Í∏Ä ÏÑ†ÌÉù
                const idx = selectedIndices.indexOf(index);
                if (idx >= 0) {
                    selectedIndices.splice(idx, 1);
                    if (selectedIndices.length > 0) {
                        selectedIndex = selectedIndices[selectedIndices.length - 1];
                    } else {
                        selectedIndex = -1;
                    }
                } else {
                    selectedIndices.push(index);
                    selectedIndices.sort((a, b) => a - b);
                    selectedIndex = index;
                }
            } else {
                // ÏùºÎ∞ò ÌÅ¥Î¶≠: Îã®Ïùº ÏÑ†ÌÉù
                selectedIndex = index;
                selectedIndices = [index];
            }
            renderEventList();
            updatePreview();
            updateStatus();
        }
        
        function clearSelection() {
            selectedIndex = -1;
            selectedIndices = [];
        }
        
        function selectAll() {
            const events = getCurrentEvents();
            selectedIndices = events.map((_, i) => i);
            if (selectedIndices.length > 0) {
                selectedIndex = selectedIndices[0];
            }
            renderEventList();
        }

        // ===== Î™ÖÎ†πÏñ¥ Ï∂îÍ∞Ä =====
        function addCommand(type) {
            const events = getCurrentEvents();
            const insertIndex = selectedIndex >= 0 ? selectedIndex + 1 : events.length;
            const newEvent = createDefaultEvent(type);
            
            saveToHistory();
            
            // Íµ¨Ï°∞ Î∏îÎ°ùÏùÄ ÏßÅÏ†ë Ï∂îÍ∞Ä Î∂àÍ∞Ä
            if (['choice-branch', 'choice-end', 'condition-else', 'condition-end'].includes(type)) {
                showToast('Ïù¥ Î∏îÎ°ùÏùÄ ÏßÅÏ†ë Ï∂îÍ∞ÄÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            if (type === 'choice') {
                events.splice(insertIndex, 0,
                    newEvent,
                    { type: 'choice-branch', choiceType: 'custom', label: 'ÏÑ†ÌÉù 1', effects: {} },
                    { type: 'choice-branch', choiceType: 'custom', label: 'ÏÑ†ÌÉù 2', effects: {} },
                    { type: 'choice-end' }
                );
            } else if (type === 'condition') {
                events.splice(insertIndex, 0,
                    newEvent,
                    { type: 'condition-else' },
                    { type: 'condition-end' }
                );
            } else {
                events.splice(insertIndex, 0, newEvent);
            }
            
            selectedIndex = insertIndex;
            renderDayList();
            renderCommonList();
            renderEventList();
            
            // Ìé∏Ïßë Î™®Îã¨ Ïó¥Í∏∞
            const editableTypes = ['dialogue', 'bgm', 'sfx', 'label', 'jump', 'ending', 'variable', 'condition', 
                                  'comment', 'wait', 'background', 'character', 'character-hide', 'expression',
                                  'text-speed', 'text-color', 'day-transition', 'choice', 'choice-branch',
                                  'call-common', 'jump-day'];
            if (editableTypes.includes(type)) {
                editSelected();
            }
            
            triggerAutoSave();
        }

        function createDefaultEvent(type) {
            // Îã§Ïùå Day ID Ï∞æÍ∏∞
            const currentDayIndex = project.dayList.findIndex(d => d.id === currentDay);
            const nextDayId = project.dayList[currentDayIndex + 1]?.id || project.dayList[0]?.id || currentDay;
            const firstCommonId = project.commonList?.[0]?.id || '';
            
            const defaults = {
                'dialogue': { type: 'dialogue', speaker: 'inhui', text: '' },
                'choice': { type: 'choice' },
                'choice-branch': { type: 'choice-branch', choiceType: 'custom', label: 'ÏÑ†ÌÉù', effects: {} },
                'condition': { type: 'condition', variable: '', operator: '>=', value: 0 },
                'bgm': { type: 'bgm', file: '', loop: true, volume: 80 },
                'bgm-stop': { type: 'bgm-stop', fadeOut: 1000 },
                'bgm-fade': { type: 'bgm-fade', volume: 50, duration: 1000 },
                'sfx': { type: 'sfx', file: '', volume: 100 },
                'voice': { type: 'voice', file: '' },
                'day-transition': { type: 'day-transition', nextDay: nextDayId },
                'fade-black': { type: 'fade-black', duration: 1000 },
                'fade-in': { type: 'fade-in', duration: 1000 },
                'fade-white': { type: 'fade-white', duration: 1000 },
                'screen-shake': { type: 'screen-shake', duration: 500, power: 5 },
                'flash': { type: 'flash', color: '#ffffff', duration: 200 },
                'tint': { type: 'tint', color: '#000000', opacity: 0.5, duration: 500 },
                'wait': { type: 'wait', frames: 60 },
                'label': { type: 'label', name: '' },
                'jump': { type: 'jump', target: '' },
                'call-common': { type: 'call-common', commonId: firstCommonId },
                'jump-day': { type: 'jump-day', dayId: nextDayId, label: '' },
                'ending': { type: 'ending', endingId: '' },
                'return': { type: 'return' },
                'variable': { type: 'variable', variable: '', operation: 'add', value: 0 },
                'variable-show': { type: 'variable-show' },
                'background': { type: 'background', file: '', transition: 'fade', duration: 500 },
                'character': { type: 'character', character: 'inhui', position: 'center', transition: 'fade' },
                'character-hide': { type: 'character-hide', character: 'all', transition: 'fade' },
                'character-move': { type: 'character-move', character: '', from: 'left', to: 'center', duration: 500 },
                'expression': { type: 'expression', character: 'inhui', expression: 'normal' },
                'text-speed': { type: 'text-speed', speed: 'normal' },
                'text-color': { type: 'text-color', color: '#ffffff' },
                'comment': { type: 'comment', text: '' },
                'plugin': { type: 'plugin', name: '', params: {} },
                'script': { type: 'script', code: '' }
            };
            return JSON.parse(JSON.stringify(defaults[type] || { type }));
        }

        function insertCommand() {
            showCommandPicker();
        }

        function insertAbove() {
            if (selectedIndex > 0) selectedIndex--;
            showCommandPicker();
        }

        function insertBelow() {
            showCommandPicker();
        }

        function showCommandPicker() {
            const allCommands = Object.values(COMMANDS).flatMap(cat => 
                cat.items.map(cmd => ({ ...cmd, category: cat.name }))
            );
            
            showModal(`
                <div class="modal-header">Î™ÖÎ†πÏñ¥ Ï∂îÍ∞Ä</div>
                <div class="modal-body">
                    <div class="form-row">
                        <input type="text" class="form-input" id="cmdPickerSearch" 
                               placeholder="Î™ÖÎ†πÏñ¥ Í≤ÄÏÉâ..." oninput="filterCommandPicker(this.value)" autofocus>
                    </div>
                    <div id="cmdPickerList" style="max-height: 350px; overflow-y: auto;">
                        ${Object.entries(COMMANDS).map(([key, cat]) => `
                            <div style="margin-bottom: 10px;">
                                <div style="font-size: 11px; color: #888; padding: 4px 0; border-bottom: 1px solid #333;">${cat.name}</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; padding-top: 4px;">
                                    ${cat.items.map(cmd => `
                                        <button class="toolbar-btn cmd-picker-item" data-type="${cmd.type}" data-name="${cmd.name}"
                                                onclick="closeModal(); addCommand('${cmd.type}')"
                                                style="justify-content: flex-start; padding: 8px;">
                                            ${cmd.icon} ${cmd.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                </div>
            `);
        }

        function filterCommandPicker(query) {
            const q = query.toLowerCase();
            document.querySelectorAll('.cmd-picker-item').forEach(btn => {
                const name = btn.dataset.name.toLowerCase();
                const type = btn.dataset.type.toLowerCase();
                btn.style.display = (name.includes(q) || type.includes(q)) ? '' : 'none';
            });
        }

        // ===== Ìé∏Ïßë Î™®Îã¨Îì§ =====
        function editSelected() {
            if (selectedIndex < 0) return;
            const events = getCurrentEvents();
            const event = events[selectedIndex];
            if (!event) return;
            
            switch (event.type) {
                case 'dialogue':
                    showDialogueModal(event);
                    break;
                case 'choice':
                    showChoiceModal(selectedIndex);
                    break;
                case 'choice-branch':
                    showChoiceBranchModal(event);
                    break;
                case 'condition':
                    showConditionModal(event);
                    break;
                case 'variable':
                    showVariableModal(event);
                    break;
                case 'bgm':
                    showBgmModal(event);
                    break;
                case 'sfx':
                    showSfxModal(event);
                    break;
                case 'background':
                    showBackgroundModal(event);
                    break;
                case 'character':
                    showCharacterModal(event);
                    break;
                case 'character-hide':
                    showCharacterHideModal(event);
                    break;
                case 'expression':
                    showExpressionModal(event);
                    break;
                case 'label':
                    showLabelModal(event);
                    break;
                case 'jump':
                    showJumpModal(event);
                    break;
                case 'call-common':
                    showCallCommonModal(event);
                    break;
                case 'jump-day':
                    showJumpDayModal(event);
                    break;
                case 'ending':
                    showEndingModal(event);
                    break;
                case 'wait':
                    showWaitModal(event);
                    break;
                case 'day-transition':
                    showDayTransitionModal(event);
                    break;
                case 'comment':
                    showCommentModal(event);
                    break;
                case 'text-speed':
                    showTextSpeedModal(event);
                    break;
                case 'text-color':
                    showTextColorModal(event);
                    break;
                default:
                    showToast('Ïù¥ Î™ÖÎ†πÏñ¥Îäî Ìé∏ÏßëÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
            }
        }

        function showDialogueModal(event) {
            const charOptions = project.characters.map(c => 
                `<option value="${c.id}" ${event.speaker === c.id ? 'selected' : ''}>${c.name}</option>`
            ).join('');
            
            showModal(`
                <div class="modal-header">ÎåÄÏÇ¨ ÌëúÏãú</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÌôîÏûê</label>
                        <select class="form-select" id="editSpeaker">${charOptions}</select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">ÎåÄÏÇ¨ ÎÇ¥Ïö©</label>
                        <textarea class="form-textarea" id="editText" placeholder="ÎåÄÏÇ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." 
                                  style="min-height: 120px;">${event.text || ''}</textarea>
                        <div class="form-hint">
                            ÌäπÏàò ÌÉúÍ∑∏: \\n (Ï§ÑÎ∞îÍøà), \\c[#ÏÉâÏÉÅÏΩîÎìú] (ÏÉâÏÉÅ), \\s[ÏÜçÎèÑ] (ÏÜçÎèÑ)
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveDialogue()">ÌôïÏù∏</button>
                </div>
            `);
            setTimeout(() => document.getElementById('editText').focus(), 100);
        }

        function saveDialogue() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.speaker = document.getElementById('editSpeaker').value;
            event.text = document.getElementById('editText').value;
            closeModal();
            renderEventList();
            updatePreview();
            triggerAutoSave();
        }

        // ÏÑ†ÌÉùÏßÄ Î∏îÎ°ù Í¥ÄÎ¶¨ Î™®Îã¨
        let editingChoiceIndex = -1;
        
        function showChoiceModal(choiceIndex) {
            editingChoiceIndex = choiceIndex;
            const events = getCurrentEvents();
            
            // Ïù¥ choice Î∏îÎ°ùÏóê ÏÜçÌïú Î∂ÑÍ∏∞Îì§ Ï∞æÍ∏∞
            const branches = [];
            let i = choiceIndex + 1;
            let depth = 1;
            
            while (i < events.length && depth > 0) {
                const e = events[i];
                if (e.type === 'choice') depth++;
                if (e.type === 'choice-end') depth--;
                if (depth === 1 && e.type === 'choice-branch') {
                    branches.push({ index: i, event: e });
                }
                i++;
            }
            
            const branchesHtml = branches.map((b, idx) => {
                const label = b.event.choiceType === 'nod' ? 'ÎÅÑÎçïÏù∏Îã§' :
                              b.event.choiceType === 'shake' ? 'Ï†ìÎäîÎã§' :
                              (b.event.label || 'ÏÑ†ÌÉù ' + (idx + 1));
                const effectsStr = formatEffects(b.event.effects);
                return `
                    <div class="choice-branch-item" data-branch-index="${b.index}" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #2d2d30; border-radius: 4px; margin-bottom: 8px;">
                        <span style="flex: 1;">
                            <strong style="color: #dcdcaa;">${idx + 1}.</strong> 
                            <span style="color: #ce9178;">${label}</span>
                            <span style="color: #888; font-size: 11px; margin-left: 8px;">${effectsStr}</span>
                        </span>
                        <button class="toolbar-btn" onclick="editBranchInChoice(${b.index})" style="padding: 4px 8px;">Ìé∏Ïßë</button>
                        ${branches.length > 1 ? `<button class="toolbar-btn" onclick="removeBranchFromChoice(${b.index})" style="padding: 4px 8px; color: #f44;">√ó</button>` : ''}
                    </div>
                `;
            }).join('');
            
            showModal(`
                <div class="modal-header">ÏÑ†ÌÉùÏßÄ Î∏îÎ°ù Ìé∏Ïßë</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÏÑ†ÌÉùÏßÄ Î∂ÑÍ∏∞ (${branches.length}Í∞ú)</label>
                        <div id="choiceBranchesList">
                            ${branchesHtml || '<div style="color: #666;">Î∂ÑÍ∏∞ ÏóÜÏùå</div>'}
                        </div>
                        <button type="button" class="toolbar-btn" onclick="addBranchToChoice()" style="margin-top: 12px; width: 100%;">
                            + ÏÑ†ÌÉùÏßÄ Ï∂îÍ∞Ä
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn primary" onclick="closeModal()">Îã´Í∏∞</button>
                </div>
            `);
        }
        
        function addBranchToChoice() {
            if (editingChoiceIndex < 0) return;
            
            const events = getCurrentEvents();
            
            // choice-end ÏúÑÏπò Ï∞æÍ∏∞
            let endIndex = editingChoiceIndex + 1;
            let depth = 1;
            while (endIndex < events.length && depth > 0) {
                if (events[endIndex].type === 'choice') depth++;
                if (events[endIndex].type === 'choice-end') depth--;
                endIndex++;
            }
            endIndex--; // choice-end ÏúÑÏπò
            
            // ÏÉà Î∂ÑÍ∏∞ ÏÇΩÏûÖ (choice-end Î∞îÎ°ú ÏïûÏóê)
            saveToHistory();
            const branchCount = events.slice(editingChoiceIndex + 1, endIndex)
                .filter(e => e.type === 'choice-branch').length;
            
            events.splice(endIndex, 0, {
                type: 'choice-branch',
                choiceType: 'custom',
                label: 'ÏÑ†ÌÉù ' + (branchCount + 1),
                effects: {}
            });
            
            renderEventList();
            showChoiceModal(editingChoiceIndex); // Î™®Îã¨ ÏÉàÎ°úÍ≥†Ïπ®
            triggerAutoSave();
        }
        
        function removeBranchFromChoice(branchIndex) {
            saveToHistory();
            getCurrentEvents().splice(branchIndex, 1);
            renderEventList();
            showChoiceModal(editingChoiceIndex); // Î™®Îã¨ ÏÉàÎ°úÍ≥†Ïπ®
            triggerAutoSave();
        }
        
        function editBranchInChoice(branchIndex) {
            closeModal();
            selectedIndex = branchIndex;
            selectedIndices = [branchIndex];
            renderEventList();
            showChoiceBranchModal(getCurrentEvents()[branchIndex]);
        }

        function showChoiceBranchModal(event) {
            const usedVars = getUsedVariables();
            const effects = event.effects || {};
            const isCustom = event.choiceType === 'custom' || (event.choiceType !== 'nod' && event.choiceType !== 'shake');
            
            // Ìö®Í≥º Î™©Î°ù HTML ÏÉùÏÑ±
            const effectsHtml = Object.entries(effects).map(([varName, value], idx) => `
                <div class="effect-row" data-idx="${idx}" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                    <input type="text" class="form-input effect-var" list="effectVarList" 
                           placeholder="Î≥ÄÏàòÎ™Ö" value="${varName}" style="flex: 1;">
                    <input type="number" class="form-input effect-val" value="${value}" style="width: 80px;">
                    <button type="button" class="toolbar-btn" onclick="removeEffectRow(this)" style="padding: 4px 8px;">√ó</button>
                </div>
            `).join('');
            
            const varOptions = usedVars.map(v => `<option value="${v}">${getVariableDisplayName(v)}</option>`).join('');
            
            showModal(`
                <div class="modal-header">ÏÑ†ÌÉùÏßÄ Î∂ÑÍ∏∞</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÏÑ†ÌÉù ÌÉÄÏûÖ</label>
                        <select class="form-select" id="editChoiceType" onchange="toggleCustomLabel()">
                            <option value="nod" ${event.choiceType === 'nod' ? 'selected' : ''}>ÎÅÑÎçïÏù∏Îã§ (‚Üì)</option>
                            <option value="shake" ${event.choiceType === 'shake' ? 'selected' : ''}>Ï†ìÎäîÎã§ (‚Üî)</option>
                            <option value="custom" ${isCustom ? 'selected' : ''}>Ïª§Ïä§ÌÖÄ ÏÑ†ÌÉùÏßÄ</option>
                        </select>
                    </div>
                    <div class="form-row" id="customLabelRow" style="display: ${isCustom ? 'block' : 'none'};">
                        <label class="form-label">ÏÑ†ÌÉùÏßÄ ÌÖçÏä§Ìä∏</label>
                        <input type="text" class="form-input" id="editChoiceLabel" 
                               placeholder="ÏÑ†ÌÉùÏßÄÏóê ÌëúÏãúÎê† ÌÖçÏä§Ìä∏" value="${event.label || ''}">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Î≥ÄÏàò Ìö®Í≥º</label>
                        <datalist id="effectVarList">
                            ${varOptions}
                        </datalist>
                        <div id="effectsList">
                            ${effectsHtml || '<div style="color: #666; font-size: 11px;">Ìö®Í≥º ÏóÜÏùå</div>'}
                        </div>
                        <button type="button" class="toolbar-btn" onclick="addEffectRow()" style="margin-top: 8px;">
                            + Ìö®Í≥º Ï∂îÍ∞Ä
                        </button>
                        <div class="form-hint">Î≥ÄÏàòÎ™ÖÍ≥º Ï¶ùÍ∞êÍ∞íÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveChoiceBranch()">ÌôïÏù∏</button>
                </div>
            `);
            
            // Ìö®Í≥ºÍ∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Ìñâ Ï∂îÍ∞Ä
            if (Object.keys(effects).length === 0) {
                addEffectRow();
            }
        }

        function toggleCustomLabel() {
            const type = document.getElementById('editChoiceType').value;
            document.getElementById('customLabelRow').style.display = type === 'custom' ? 'block' : 'none';
        }

        function addEffectRow() {
            const container = document.getElementById('effectsList');
            // ÏïàÎÇ¥ Î¨∏Íµ¨ Ï†úÍ±∞
            const placeholder = container.querySelector('div[style*="color: #666"]');
            if (placeholder) placeholder.remove();
            
            const idx = container.querySelectorAll('.effect-row').length;
            const row = document.createElement('div');
            row.className = 'effect-row';
            row.dataset.idx = idx;
            row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
            row.innerHTML = `
                <input type="text" class="form-input effect-var" list="effectVarList" 
                       placeholder="Î≥ÄÏàòÎ™Ö" value="" style="flex: 1;">
                <input type="number" class="form-input effect-val" value="0" style="width: 80px;">
                <button type="button" class="toolbar-btn" onclick="removeEffectRow(this)" style="padding: 4px 8px;">√ó</button>
            `;
            container.appendChild(row);
        }

        function removeEffectRow(btn) {
            btn.closest('.effect-row').remove();
        }

        function saveChoiceBranch() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.choiceType = document.getElementById('editChoiceType').value;
            
            // Ïª§Ïä§ÌÖÄ ÏÑ†ÌÉùÏßÄÎ©¥ Î†àÏù¥Î∏î Ï†ÄÏû•
            if (event.choiceType === 'custom') {
                event.label = document.getElementById('editChoiceLabel').value.trim() || 'ÏÑ†ÌÉù';
            } else {
                delete event.label;
            }
            
            // Ìö®Í≥º ÏàòÏßë
            const effects = {};
            document.querySelectorAll('.effect-row').forEach(row => {
                const varName = row.querySelector('.effect-var').value.trim();
                const value = parseInt(row.querySelector('.effect-val').value) || 0;
                if (varName) {
                    effects[varName] = value;
                }
            });
            event.effects = effects;
            
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showConditionModal(event) {
            const usedVars = getUsedVariables();
            const varOptions = usedVars.map(v => `<option value="${v}">`).join('');
            
            showModal(`
                <div class="modal-header">Ï°∞Í±¥ Î∂ÑÍ∏∞</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ï°∞Í±¥Ïãù</label>
                        <div class="form-grid three">
                            <div>
                                <input type="text" class="form-input" id="editCondVar" list="varList"
                                       placeholder="Î≥ÄÏàòÎ™Ö" value="${event.variable || ''}">
                                <datalist id="varList">
                                    ${varOptions}
                                </datalist>
                            </div>
                            <select class="form-select" id="editCondOp">
                                <option value=">=" ${event.operator === '>=' ? 'selected' : ''}>‚â• (Ïù¥ÏÉÅ)</option>
                                <option value=">" ${event.operator === '>' ? 'selected' : ''}>> (Ï¥àÍ≥º)</option>
                                <option value="<=" ${event.operator === '<=' ? 'selected' : ''}>‚â§ (Ïù¥Ìïò)</option>
                                <option value="<" ${event.operator === '<' ? 'selected' : ''}>< (ÎØ∏Îßå)</option>
                                <option value="==" ${event.operator === '==' ? 'selected' : ''}> = (Í∞ôÏùå)</option>
                                <option value="!=" ${event.operator === '!=' ? 'selected' : ''}>‚â† (Îã§Î¶Ñ)</option>
                            </select>
                            <input type="number" class="form-input" id="editCondVal" value="${event.value || 0}">
                        </div>
                        <div class="form-hint">Î≥ÄÏàòÎ™ÖÏùÑ ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveCondition()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveCondition() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.variable = document.getElementById('editCondVar').value;
            event.operator = document.getElementById('editCondOp').value;
            event.value = parseInt(document.getElementById('editCondVal').value) || 0;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showVariableModal(event) {
            const usedVars = getUsedVariables();
            const varOptions = usedVars.map(v => `<option value="${v}">`).join('');
            
            showModal(`
                <div class="modal-header">Î≥ÄÏàò Ï°∞Ïûë</div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-grid three">
                            <div>
                                <label class="form-label">Î≥ÄÏàò</label>
                                <input type="text" class="form-input" id="editVarName" list="varListEdit"
                                       placeholder="Î≥ÄÏàòÎ™Ö" value="${event.variable || ''}">
                                <datalist id="varListEdit">
                                    ${varOptions}
                                </datalist>
                            </div>
                            <div>
                                <label class="form-label">Ïó∞ÏÇ∞</label>
                                <select class="form-select" id="editVarOp">
                                    <option value="add" ${event.operation === 'add' ? 'selected' : ''}>+= ÎçîÌïòÍ∏∞</option>
                                    <option value="sub" ${event.operation === 'sub' ? 'selected' : ''}>-= ÎπºÍ∏∞</option>
                                    <option value="set" ${event.operation === 'set' ? 'selected' : ''}>= ÎåÄÏûÖ</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Í∞í</label>
                                <input type="number" class="form-input" id="editVarVal" value="${event.value || 0}">
                            </div>
                        </div>
                        <div class="form-hint">Î≥ÄÏàòÎ™ÖÏùÑ ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveVariable()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveVariable() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.variable = document.getElementById('editVarName').value;
            event.operation = document.getElementById('editVarOp').value;
            event.value = parseInt(document.getElementById('editVarVal').value) || 0;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showBgmModal(event) {
            showModal(`
                <div class="modal-header">BGM Ïû¨ÏÉù</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÌååÏùº Í≤ΩÎ°ú</label>
                        <input type="text" class="form-input" id="editFile" placeholder="bgm/night.mp3" value="${event.file || ''}">
                    </div>
                    <div class="form-row">
                        <div class="form-grid">
                            <div>
                                <label class="form-label">Î≥ºÎ•® (0~100)</label>
                                <input type="number" class="form-input" id="editVolume" min="0" max="100" value="${event.volume || 80}">
                            </div>
                            <div>
                                <label class="form-label">ÌéòÏù¥ÎìúÏù∏ (ms)</label>
                                <input type="number" class="form-input" id="editFadeIn" min="0" value="${event.fadeIn || 0}">
                            </div>
                        </div>
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="editLoop" ${event.loop !== false ? 'checked' : ''}>
                        <label for="editLoop">Î∞òÎ≥µ Ïû¨ÏÉù</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveBgm()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveBgm() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.file = document.getElementById('editFile').value;
            event.volume = parseInt(document.getElementById('editVolume').value) || 80;
            event.fadeIn = parseInt(document.getElementById('editFadeIn').value) || 0;
            event.loop = document.getElementById('editLoop').checked;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showSfxModal(event) {
            showModal(`
                <div class="modal-header">Ìö®Í≥ºÏùå Ïû¨ÏÉù</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÌååÏùº Í≤ΩÎ°ú</label>
                        <input type="text" class="form-input" id="editFile" placeholder="sfx/click.mp3" value="${event.file || ''}">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Î≥ºÎ•® (0~100)</label>
                        <input type="number" class="form-input" id="editVolume" min="0" max="100" value="${event.volume || 100}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveSfx()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveSfx() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.file = document.getElementById('editFile').value;
            event.volume = parseInt(document.getElementById('editVolume').value) || 100;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showBackgroundModal(event) {
            showModal(`
                <div class="modal-header">Î∞∞Í≤Ω Î≥ÄÍ≤Ω</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Î∞∞Í≤Ω ÌååÏùº</label>
                        <input type="text" class="form-input" id="editFile" placeholder="bg/room.png" value="${event.file || ''}">
                    </div>
                    <div class="form-row">
                        <div class="form-grid">
                            <div>
                                <label class="form-label">Ï†ÑÌôò Ìö®Í≥º</label>
                                <select class="form-select" id="editTransition">
                                    <option value="fade" ${event.transition === 'fade' ? 'selected' : ''}>ÌéòÏù¥Îìú</option>
                                    <option value="dissolve" ${event.transition === 'dissolve' ? 'selected' : ''}>ÎîîÏ°∏Î∏å</option>
                                    <option value="none" ${event.transition === 'none' ? 'selected' : ''}>Ï¶âÏãú</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">ÏãúÍ∞Ñ (ms)</label>
                                <input type="number" class="form-input" id="editDuration" value="${event.duration || 500}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveBackground()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveBackground() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.file = document.getElementById('editFile').value;
            event.transition = document.getElementById('editTransition').value;
            event.duration = parseInt(document.getElementById('editDuration').value) || 500;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showCharacterModal(event) {
            const charOptions = project.characters.filter(c => c.id !== 'narration').map(c => 
                `<option value="${c.id}" ${event.character === c.id ? 'selected' : ''}>${c.name}</option>`
            ).join('');
            
            showModal(`
                <div class="modal-header">Ï∫êÎ¶≠ÌÑ∞ ÌëúÏãú</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ï∫êÎ¶≠ÌÑ∞</label>
                        <select class="form-select" id="editCharacter">${charOptions}</select>
                    </div>
                    <div class="form-row">
                        <div class="form-grid">
                            <div>
                                <label class="form-label">ÏúÑÏπò</label>
                                <select class="form-select" id="editPosition">
                                    <option value="left" ${event.position === 'left' ? 'selected' : ''}>ÏôºÏ™Ω</option>
                                    <option value="center" ${event.position === 'center' ? 'selected' : ''}>Ï§ëÏïô</option>
                                    <option value="right" ${event.position === 'right' ? 'selected' : ''}>Ïò§Î•∏Ï™Ω</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Ï†ÑÌôò Ìö®Í≥º</label>
                                <select class="form-select" id="editTransition">
                                    <option value="fade" ${event.transition === 'fade' ? 'selected' : ''}>ÌéòÏù¥Îìú</option>
                                    <option value="slide" ${event.transition === 'slide' ? 'selected' : ''}>Ïä¨ÎùºÏù¥Îìú</option>
                                    <option value="none" ${event.transition === 'none' ? 'selected' : ''}>Ï¶âÏãú</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveCharacter()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveCharacter() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.character = document.getElementById('editCharacter').value;
            event.position = document.getElementById('editPosition').value;
            event.transition = document.getElementById('editTransition').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showCharacterHideModal(event) {
            const charOptions = project.characters.filter(c => c.id !== 'narration').map(c => 
                `<option value="${c.id}" ${event.character === c.id ? 'selected' : ''}>${c.name}</option>`
            ).join('');
            
            showModal(`
                <div class="modal-header">Ï∫êÎ¶≠ÌÑ∞ Ïà®Í∏∞Í∏∞</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ï∫êÎ¶≠ÌÑ∞</label>
                        <select class="form-select" id="editCharacter">
                            <option value="all" ${event.character === 'all' ? 'selected' : ''}>Ï†ÑÏ≤¥</option>
                            ${charOptions}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveCharacterHide()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveCharacterHide() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.character = document.getElementById('editCharacter').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showExpressionModal(event) {
            const charOptions = project.characters.filter(c => c.id !== 'narration').map(c => 
                `<option value="${c.id}" ${event.character === c.id ? 'selected' : ''}>${c.name}</option>`
            ).join('');
            
            showModal(`
                <div class="modal-header">ÌëúÏ†ï Î≥ÄÍ≤Ω</div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-grid">
                            <div>
                                <label class="form-label">Ï∫êÎ¶≠ÌÑ∞</label>
                                <select class="form-select" id="editCharacter">${charOptions}</select>
                            </div>
                            <div>
                                <label class="form-label">ÌëúÏ†ï</label>
                                <input type="text" class="form-input" id="editExpression" 
                                       placeholder="normal, happy, sad..." value="${event.expression || ''}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveExpression()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveExpression() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.character = document.getElementById('editCharacter').value;
            event.expression = document.getElementById('editExpression').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showLabelModal(event) {
            showModal(`
                <div class="modal-header">ÎùºÎ≤®</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÎùºÎ≤® Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-input" id="editLabelName" 
                               placeholder="Ïòà: ending_good" value="${event.name || ''}">
                        <div class="form-hint">ÏòÅÎ¨∏, Ïà´Ïûê, Î∞ëÏ§Ñ(_)Îßå ÏÇ¨Ïö© Í∂åÏû•</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveLabel()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveLabel() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.name = document.getElementById('editLabelName').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showJumpModal(event) {
            // ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏Ïùò Î™®Îì† ÎùºÎ≤® ÏàòÏßë
            const labels = [];
            project.dayList.forEach(day => {
                (project.days[day.id] || []).forEach(e => {
                    if (e.type === 'label' && e.name) {
                        labels.push({ dayId: day.id, dayName: day.name, name: e.name });
                    }
                });
            });
            
            const labelOptions = labels.map(l => 
                `<option value="${l.name}" ${event.target === l.name ? 'selected' : ''}>${l.name} (${l.dayName})</option>`
            ).join('');
            
            showModal(`
                <div class="modal-header">ÎùºÎ≤®Î°ú Ïù¥Îèô</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ïù¥ÎèôÌï† ÎùºÎ≤®</label>
                        ${labels.length > 0 ? `
                            <select class="form-select" id="editJumpTarget">
                                <option value="">ÏßÅÏ†ë ÏûÖÎ†•...</option>
                                ${labelOptions}
                            </select>
                        ` : ''}
                        <input type="text" class="form-input" id="editJumpTargetCustom" 
                               placeholder="ÎùºÎ≤® Ïù¥Î¶Ñ ÏûÖÎ†•" value="${event.target || ''}" style="margin-top: 8px;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveJump()">ÌôïÏù∏</button>
                </div>
            `);
            
            // ÏÖÄÎ†âÌä∏ Î≥ÄÍ≤Ω Ïãú ÏûÖÎ†• ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏
            const select = document.getElementById('editJumpTarget');
            if (select) {
                select.addEventListener('change', () => {
                    if (select.value) {
                        document.getElementById('editJumpTargetCustom').value = select.value;
                    }
                });
            }
        }

        function saveJump() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.target = document.getElementById('editJumpTargetCustom').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showEndingModal(event) {
            showModal(`
                <div class="modal-header">ÏóîÎî©</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÏóîÎî© Ï¢ÖÎ•ò</label>
                        <select class="form-select" id="editEndingId">
                            <option value="true_end" ${event.endingId === 'true_end' ? 'selected' : ''}>Ìä∏Î£® ÏóîÎî© (Ïù¥Ìï¥)</option>
                            <option value="obsession_end" ${event.endingId === 'obsession_end' ? 'selected' : ''}>ÏßëÏ∞© ÏóîÎî© (Ïò§Ìï¥)</option>
                            <option value="neutral_end" ${event.endingId === 'neutral_end' ? 'selected' : ''}>Ï§ëÎ¶Ω ÏóîÎî©</option>
                            <option value="bad_end" ${event.endingId === 'bad_end' ? 'selected' : ''}>Î∞∞Îìú ÏóîÎî©</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveEnding()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveEnding() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.endingId = document.getElementById('editEndingId').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showWaitModal(event) {
            showModal(`
                <div class="modal-header">ÎåÄÍ∏∞</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÎåÄÍ∏∞ ÏãúÍ∞Ñ</label>
                        <div class="form-grid">
                            <div>
                                <input type="number" class="form-input" id="editFrames" min="1" value="${event.frames || 60}">
                                <div class="form-hint">ÌîÑÎ†àÏûÑ (60 = 1Ï¥à)</div>
                            </div>
                            <div>
                                <input type="number" class="form-input" id="editSeconds" min="0" step="0.1" 
                                       value="${((event.frames || 60) / 60).toFixed(1)}">
                                <div class="form-hint">Ï¥à</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveWait()">ÌôïÏù∏</button>
                </div>
            `);
            
            // ÎèôÍ∏∞Ìôî
            document.getElementById('editFrames').addEventListener('input', (e) => {
                document.getElementById('editSeconds').value = (parseInt(e.target.value) / 60).toFixed(1);
            });
            document.getElementById('editSeconds').addEventListener('input', (e) => {
                document.getElementById('editFrames').value = Math.round(parseFloat(e.target.value) * 60);
            });
        }

        function saveWait() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.frames = parseInt(document.getElementById('editFrames').value) || 60;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showDayTransitionModal(event) {
            const dayOptions = project.dayList.map(d => 
                `<option value="${d.id}" ${event.nextDay === d.id ? 'selected' : ''}>${d.name}</option>`
            ).join('');
            
            showModal(`
                <div class="modal-header">ÌïòÎ£® Ï†ÑÌôò</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Îã§Ïùå ÎÇ†Ïßú</label>
                        <select class="form-select" id="editNextDay">
                            ${dayOptions}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveDayTransition()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveDayTransition() {
            saveToHistory();
            const events = getCurrentEvents();
            const event = events[selectedIndex];
            event.nextDay = document.getElementById('editNextDay').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showCallCommonModal(event) {
            if (!project.commonList || project.commonList.length === 0) {
                showToast('Ïª§Î®º Ïù¥Î≤§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Ïª§Î®º Ïù¥Î≤§Ìä∏Î•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            const commonOptions = project.commonList.map(c => 
                `<option value="${c.id}" ${event.commonId === c.id ? 'selected' : ''}>${c.name}</option>`
            ).join('');
            
            showModal(`
                <div class="modal-header">Ïª§Î®º Ïù¥Î≤§Ìä∏ Ìò∏Ï∂ú</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ïª§Î®º Ïù¥Î≤§Ìä∏</label>
                        <select class="form-select" id="editCommonId">
                            ${commonOptions}
                        </select>
                    </div>
                    <div class="form-hint">Ìò∏Ï∂úÎêú Ïª§Î®º Ïù¥Î≤§Ìä∏ Ïã§Ìñâ ÌõÑ ÏõêÎûò ÏúÑÏπòÎ°ú Î≥µÍ∑ÄÌï©ÎãàÎã§.</div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveCallCommon()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveCallCommon() {
            saveToHistory();
            const events = getCurrentEvents();
            const event = events[selectedIndex];
            event.commonId = document.getElementById('editCommonId').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showJumpDayModal(event) {
            const dayOptions = project.dayList.map(d => 
                `<option value="${d.id}" ${event.dayId === d.id ? 'selected' : ''}>${d.name}</option>`
            ).join('');
            
            // ÏÑ†ÌÉùÎêú DayÏùò ÎùºÎ≤®Îì§ ÏàòÏßë
            const labels = [];
            project.dayList.forEach(d => {
                (project.days[d.id] || []).forEach(e => {
                    if (e.type === 'label' && e.name) {
                        labels.push({ dayId: d.id, dayName: d.name, label: e.name });
                    }
                });
            });
            
            const labelOptions = labels.map(l => 
                `<option value="${l.label}" data-day="${l.dayId}" ${event.label === l.label && event.dayId === l.dayId ? 'selected' : ''}>[${l.dayName}] ${l.label}</option>`
            ).join('');
            
            showModal(`
                <div class="modal-header">Day Ïù¥Îèô</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ïù¥ÎèôÌï† Day</label>
                        <select class="form-select" id="editJumpDay">
                            ${dayOptions}
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">ÎùºÎ≤® (ÏÑ†ÌÉù)</label>
                        <input type="text" class="form-input" id="editJumpLabel" list="jumpLabelList"
                               placeholder="ÎùºÎ≤® ÏóÜÏùå (Ï≤òÏùåÎ∂ÄÌÑ∞)" value="${event.label || ''}">
                        <datalist id="jumpLabelList">
                            ${labelOptions}
                        </datalist>
                    </div>
                    <div class="form-hint">ÎùºÎ≤®ÏùÑ ÏßÄÏ†ïÌïòÎ©¥ Ìï¥Îãπ ÎùºÎ≤®Î∂ÄÌÑ∞ ÏãúÏûëÌï©ÎãàÎã§.</div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveJumpDay()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveJumpDay() {
            saveToHistory();
            const events = getCurrentEvents();
            const event = events[selectedIndex];
            event.dayId = document.getElementById('editJumpDay').value;
            event.label = document.getElementById('editJumpLabel').value.trim();
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showCommentModal(event) {
            showModal(`
                <div class="modal-header">Ï£ºÏÑù</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Î©îÎ™®</label>
                        <textarea class="form-textarea" id="editComment" placeholder="ÏûëÏóÖ Î©îÎ™®...">${event.text || ''}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveComment()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveComment() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.text = document.getElementById('editComment').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showTextSpeedModal(event) {
            showModal(`
                <div class="modal-header">ÌÖçÏä§Ìä∏ ÏÜçÎèÑ</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÏÜçÎèÑ</label>
                        <select class="form-select" id="editSpeed">
                            <option value="instant" ${event.speed === 'instant' ? 'selected' : ''}>Ï¶âÏãú (0)</option>
                            <option value="fast" ${event.speed === 'fast' ? 'selected' : ''}>Îπ†Î¶Ñ (1)</option>
                            <option value="normal" ${event.speed === 'normal' ? 'selected' : ''}>Î≥¥ÌÜµ (2)</option>
                            <option value="slow" ${event.speed === 'slow' ? 'selected' : ''}>ÎäêÎ¶º (3)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveTextSpeed()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveTextSpeed() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.speed = document.getElementById('editSpeed').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        function showTextColorModal(event) {
            showModal(`
                <div class="modal-header">ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÏÉâÏÉÅ</label>
                        <input type="color" class="form-input" id="editColor" value="${event.color || '#ffffff'}" style="height: 40px;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveTextColor()">ÌôïÏù∏</button>
                </div>
            `);
        }

        function saveTextColor() {
            saveToHistory();
            const event = getCurrentEvents()[selectedIndex];
            event.color = document.getElementById('editColor').value;
            closeModal();
            renderEventList();
            triggerAutoSave();
        }

        // ===== ÏÇ≠Ï†ú/Î≥µÏÇ¨/Ïù¥Îèô =====
        function deleteSelected() {
            if (selectedIndices.length === 0 && selectedIndex < 0) return;
            
            const events = getCurrentEvents();
            if (!events || events.length === 0) return;
            
            // ÏÑ†ÌÉùÎêú Ïù∏Îç±Ïä§Îì§ (ÏóÜÏúºÎ©¥ ÌòÑÏû¨ ÏÑ†ÌÉù)
            let toDelete = selectedIndices.length > 0 ? [...selectedIndices] : [selectedIndex];
            
            // Ïú†Ìö®Ìïú Ïù∏Îç±Ïä§Îßå ÌïÑÌÑ∞ÎßÅ
            toDelete = toDelete.filter(idx => idx >= 0 && idx < events.length && events[idx]);
            if (toDelete.length === 0) return;
            
            // choice/condition Î∏îÎ°ùÏù¥ ÏÑ†ÌÉùÎêòÏñ¥ ÏûàÏúºÎ©¥ Í∑∏ Î≤îÏúÑÏùò ÌïòÏúÑ Î∏îÎ°ùÎì§ Ïù∏Îç±Ïä§ ÏàòÏßë
            const coveredByParent = new Set();
            for (const idx of toDelete) {
                const event = events[idx];
                if (event && (event.type === 'choice' || event.type === 'condition')) {
                    // Ïù¥ Î∏îÎ°ùÏùò ÌïòÏúÑ Î≤îÏúÑÎ•º ÏàòÏßë
                    let endIdx = idx + 1;
                    let depth = 1;
                    const endType = event.type === 'choice' ? 'choice-end' : 'condition-end';
                    while (endIdx < events.length && depth > 0) {
                        coveredByParent.add(endIdx);
                        if (events[endIdx].type === event.type) depth++;
                        if (events[endIdx].type === endType) depth--;
                        endIdx++;
                    }
                }
            }
            
            // Íµ¨Ï°∞ Î∏îÎ°ù Ï≤¥ÌÅ¨ (ÏÉÅÏúÑ Î∏îÎ°ùÏù¥ ÏÑ†ÌÉùÎêòÏñ¥ ÏûàÏúºÎ©¥ Ïä§ÌÇµ)
            for (const idx of toDelete) {
                if (coveredByParent.has(idx)) continue; // ÏÉÅÏúÑ Î∏îÎ°ùÏóê Ìè¨Ìï®Îê®
                const event = events[idx];
                if (event && ['choice-branch', 'choice-end', 'condition-else', 'condition-end'].includes(event.type)) {
                    showToast('ÏÑ†ÌÉùÏßÄ/Ï°∞Í±¥ Î∏îÎ°ùÏùò ÏùºÎ∂ÄÏûÖÎãàÎã§. ÏÉÅÏúÑ Î∏îÎ°ùÏùÑ Ìé∏ÏßëÌïòÍ±∞ÎÇò ÏÇ≠Ï†úÌïòÏÑ∏Ïöî.', 'warning');
                    return;
                }
            }
            
            // Ïã§Ï†ú ÏÇ≠Ï†ú Ïã§Ìñâ Ìï®Ïàò
            const executeDelete = () => {
                saveToHistory();
                
                // ÌïòÏúÑ Î∏îÎ°ùÏùÄ ÏÉÅÏúÑ Î∏îÎ°ù ÏÇ≠Ï†úÏãú Í∞ôÏù¥ ÏÇ≠Ï†úÎêòÎØÄÎ°ú Ï†úÏô∏
                const finalDelete = toDelete.filter(idx => !coveredByParent.has(idx));
                
                // Ïó≠ÏàúÏúºÎ°ú ÏÇ≠Ï†ú (Ïù∏Îç±Ïä§ Ïú†ÏßÄÎ•º ÏúÑÌï¥)
                const sortedIndices = [...finalDelete].sort((a, b) => b - a);
                for (const idx of sortedIndices) {
                    const event = getCurrentEvents()[idx];
                    if (!event) continue;
                    
                    if (event.type === 'choice' || event.type === 'condition') {
                        // Î∏îÎ°ù Ï†ÑÏ≤¥ ÏÇ≠Ï†ú (choice/condition ~ choice-end/condition-end)
                        let endIndex = idx + 1;
                        let depth = 1;
                        const endType = event.type === 'choice' ? 'choice-end' : 'condition-end';
                        
                        while (endIndex < getCurrentEvents().length && depth > 0) {
                            const e = getCurrentEvents()[endIndex];
                            if (e.type === event.type) depth++;
                            if (e.type === endType) depth--;
                            endIndex++;
                        }
                        getCurrentEvents().splice(idx, endIndex - idx);
                    } else {
                        getCurrentEvents().splice(idx, 1);
                    }
                }
                
                selectedIndex = Math.min(toDelete[0], getCurrentEvents().length - 1);
                selectedIndices = selectedIndex >= 0 ? [selectedIndex] : [];
                renderDayList();
                renderEventList();
                triggerAutoSave();
            };
            
            // choiceÎÇò condition Î∏îÎ°ùÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            let hasStructBlock = false;
            for (const idx of toDelete) {
                const event = events[idx];
                if (event && (event.type === 'choice' || event.type === 'condition')) {
                    hasStructBlock = true;
                    break;
                }
            }
            
            if (hasStructBlock) {
                showConfirmModal('Î∂ÑÍ∏∞ Î∏îÎ°ùÏù¥ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.\nÏó∞Í≤∞Îêú Î∏îÎ°ù Ï†ÑÏ≤¥Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§.\nÍ≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?', executeDelete);
            } else {
                executeDelete();
            }
        }

        function copySelected() {
            if (selectedIndices.length === 0 && selectedIndex < 0) return;
            
            const events = getCurrentEvents();
            const toCopy = (selectedIndices.length > 0 ? selectedIndices : [selectedIndex])
                .filter(idx => idx >= 0 && idx < events.length && events[idx]);
            
            if (toCopy.length === 0) return;
            
            clipboard = toCopy.map(idx => JSON.parse(JSON.stringify(events[idx])));
            showToast(`${clipboard.length}Í∞ú Î≥µÏÇ¨Îê®`, 'success');
        }

        function cutSelected() {
            copySelected();
            deleteSelected();
        }

        function pasteCommand() {
            if (!clipboard || clipboard.length === 0) {
                showToast('ÌÅ¥Î¶ΩÎ≥¥ÎìúÍ∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            saveToHistory();
            const insertIndex = selectedIndex >= 0 ? selectedIndex + 1 : getCurrentEvents().length;
            const items = clipboard.map(item => JSON.parse(JSON.stringify(item)));
            getCurrentEvents().splice(insertIndex, 0, ...items);
            
            // Î∂ôÏó¨ÎÑ£ÏùÄ Ìï≠Î™©Îì§ ÏÑ†ÌÉù
            selectedIndices = items.map((_, i) => insertIndex + i);
            selectedIndex = insertIndex;
            
            renderDayList();
            renderEventList();
            triggerAutoSave();
        }

        function duplicateSelected() {
            if (selectedIndices.length === 0 && selectedIndex < 0) return;
            copySelected();
            pasteCommand();
        }

        function moveUp() {
            if (selectedIndices.length === 0 && selectedIndex < 0) return;
            
            const toMove = selectedIndices.length > 0 ? [...selectedIndices].sort((a, b) => a - b) : [selectedIndex];
            if (toMove[0] <= 0) return;
            
            saveToHistory();
            const events = getCurrentEvents();
            
            // ÏúÑÎ°ú Ïù¥Îèô
            for (const idx of toMove) {
                [events[idx - 1], events[idx]] = [events[idx], events[idx - 1]];
            }
            
            selectedIndices = toMove.map(i => i - 1);
            selectedIndex = selectedIndices[0];
            renderEventList();
            triggerAutoSave();
        }

        function moveDown() {
            if (selectedIndices.length === 0 && selectedIndex < 0) return;
            
            const events = getCurrentEvents();
            const toMove = selectedIndices.length > 0 ? [...selectedIndices].sort((a, b) => b - a) : [selectedIndex];
            if (toMove[0] >= events.length - 1) return;
            
            saveToHistory();
            
            // ÏïÑÎûòÎ°ú Ïù¥Îèô (Ïó≠Ïàú)
            for (const idx of toMove) {
                [events[idx], events[idx + 1]] = [events[idx + 1], events[idx]];
            }
            
            selectedIndices = toMove.map(i => i + 1).sort((a, b) => a - b);
            selectedIndex = selectedIndices[0];
            renderEventList();
            triggerAutoSave();
        }

        // ===== ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ =====
        let draggedIndices = [];
        
        function dragStart(e, index) {
            // ÎìúÎûòÍ∑∏ ÏãúÏûëÌï† Îïå ÏÑ†ÌÉùÎêú Ìï≠Î™©Ïù¥ ÏóÜÍ±∞ÎÇò ÎìúÎûòÍ∑∏ ÎåÄÏÉÅÏù¥ ÏÑ†ÌÉùÏóê Ìè¨Ìï®ÎêòÏßÄ ÏïäÏúºÎ©¥ Îã®Ïùº ÏÑ†ÌÉù
            if (selectedIndices.length === 0 || !selectedIndices.includes(index)) {
                selectedIndices = [index];
                selectedIndex = index;
            }
            draggedIndices = [...selectedIndices];
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedIndices));
            e.dataTransfer.effectAllowed = 'move';
            
            // ÎìúÎûòÍ∑∏ Ï§ë ÌëúÏãú
            setTimeout(() => {
                draggedIndices.forEach(i => {
                    const el = document.querySelector(`[data-index="${i}"]`);
                    if (el) el.classList.add('dragging');
                });
            }, 0);
        }

        function dragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // ÎìúÎûòÍ∑∏ Ïò§Î≤Ñ ÌëúÏãú
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            e.currentTarget.classList.add('drag-over');
        }
        
        function dragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        function dragEnd(e) {
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function drop(e, targetIndex) {
            e.preventDefault();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            
            const sourceIndices = JSON.parse(e.dataTransfer.getData('text/plain'));
            if (!sourceIndices || sourceIndices.length === 0) return;
            if (sourceIndices.length === 1 && sourceIndices[0] === targetIndex) return;
            
            saveToHistory();
            const events = getCurrentEvents();
            
            // ÏÑ†ÌÉùÎêú Ïù¥Î≤§Ìä∏Îì§ Ï∂îÏ∂ú (Ïó≠ÏàúÏúºÎ°ú Ï†úÍ±∞)
            const movedEvents = [];
            const sortedIndices = [...sourceIndices].sort((a, b) => b - a);
            sortedIndices.forEach(idx => {
                movedEvents.unshift(events.splice(idx, 1)[0]);
            });
            
            // ÏÉà ÏúÑÏπò Í≥ÑÏÇ∞ (Ï†úÍ±∞Îêú Ìï≠Î™©Îì§ Í≥†Î†§)
            let newTarget = targetIndex;
            sourceIndices.forEach(idx => {
                if (idx < targetIndex) newTarget--;
            });
            newTarget = Math.max(0, Math.min(newTarget, events.length));
            
            // ÏÇΩÏûÖ
            events.splice(newTarget, 0, ...movedEvents);
            
            // ÏÑ†ÌÉù ÏóÖÎç∞Ïù¥Ìä∏
            selectedIndices = movedEvents.map((_, i) => newTarget + i);
            selectedIndex = newTarget;
            
            renderEventList();
            triggerAutoSave();
        }

        // ===== Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ =====
        function showContextMenu(e, index) {
            e.preventDefault();
            
            // Ïö∞ÌÅ¥Î¶≠Ìïú Ìï≠Î™©Ïù¥ Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêòÏñ¥ ÏûàÏúºÎ©¥ ÏÑ†ÌÉù Ïú†ÏßÄ, ÏïÑÎãàÎ©¥ Îã®Ïùº ÏÑ†ÌÉù
            if (!selectedIndices.includes(index)) {
                selectedIndex = index;
                selectedIndices = [index];
                renderEventList();
            }
            
            const menu = document.getElementById('contextMenu');
            menu.style.left = Math.min(e.pageX, window.innerWidth - 220) + 'px';
            menu.style.top = Math.min(e.pageY, window.innerHeight - 300) + 'px';
            menu.classList.add('active');
        }

        // ===== Î∂ÅÎßàÌÅ¨ =====
        function toggleBookmark() {
            if (selectedIndex < 0) return;
            
            const key = `${currentDay}-${selectedIndex}`;
            const idx = project.bookmarks.indexOf(key);
            
            if (idx >= 0) {
                project.bookmarks.splice(idx, 1);
            } else {
                project.bookmarks.push(key);
            }
            
            renderEventList();
            triggerAutoSave();
        }

        function jumpToBookmark() {
            if (project.bookmarks.length === 0) {
                showToast('Î∂ÅÎßàÌÅ¨Í∞Ä ÏóÜÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            // ÌòÑÏû¨ ÏúÑÏπò Ïù¥ÌõÑÏùò Î∂ÅÎßàÌÅ¨ Ï∞æÍ∏∞
            const currentKey = `${currentDay}-${selectedIndex}`;
            const currentIdx = project.bookmarks.indexOf(currentKey);
            const nextIdx = (currentIdx + 1) % project.bookmarks.length;
            const nextKey = project.bookmarks[nextIdx];
            const [day, index] = nextKey.split('-').map(Number);
            
            if (day !== currentDay) {
                selectDay(day);
            }
            selectedIndex = index;
            renderEventList();
        }

        // ===== ÎπÑÌôúÏÑ±Ìôî ÌÜ†Í∏Ä =====
        function toggleDisable() {
            if (selectedIndex < 0) return;
            
            const event = getCurrentEvents()[selectedIndex];
            event.disabled = !event.disabled;
            renderEventList();
            triggerAutoSave();
        }

        // ===== Í≤ÄÏÉâ =====
        function quickSearch(query) {
            searchMatches = [];
            
            if (!query.trim()) {
                document.getElementById('searchCount').textContent = '';
                renderEventList();
                return;
            }
            
            const q = query.toLowerCase();
            getCurrentEvents().forEach((event, index) => {
                const text = JSON.stringify(event).toLowerCase();
                if (text.includes(q)) {
                    searchMatches.push(index);
                }
            });
            
            document.getElementById('searchCount').textContent = `${searchMatches.length}Í±¥`;
            renderEventList();
        }

        function showFindReplace() {
            showModal(`
                <div class="modal-header">Ï∞æÍ∏∞ / Î∞îÍæ∏Í∏∞</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Ï∞æÏùÑ ÎÇ¥Ïö©</label>
                        <input type="text" class="form-input" id="findText" placeholder="Í≤ÄÏÉâÏñ¥...">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Î∞îÍøÄ ÎÇ¥Ïö©</label>
                        <input type="text" class="form-input" id="replaceText" placeholder="ÎåÄÏ≤¥Ìï† ÌÖçÏä§Ìä∏...">
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="findAllDays">
                        <label for="findAllDays">Î™®Îì† DayÏóêÏÑú Í≤ÄÏÉâ</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Îã´Í∏∞</button>
                    <button class="modal-btn" onclick="findNext()">Îã§Ïùå Ï∞æÍ∏∞</button>
                    <button class="modal-btn" onclick="replaceOne()">Î∞îÍæ∏Í∏∞</button>
                    <button class="modal-btn primary" onclick="replaceAll()">Î™®Îëê Î∞îÍæ∏Í∏∞</button>
                </div>
            `);
        }

        function findNext() {
            const query = document.getElementById('findText').value;
            if (!query) return;
            
            // Í∞ÑÎã®Ìïú Í≤ÄÏÉâ Íµ¨ÌòÑ
            quickSearch(query);
            if (searchMatches.length > 0) {
                const currentMatchIdx = searchMatches.indexOf(selectedIndex);
                const nextMatchIdx = currentMatchIdx >= 0 ? 
                    (currentMatchIdx + 1) % searchMatches.length : 0;
                selectedIndex = searchMatches[nextMatchIdx];
                renderEventList();
            }
        }

        function replaceOne() {
            const findText = document.getElementById('findText').value;
            const replaceText = document.getElementById('replaceText').value;
            
            if (!findText || selectedIndex < 0) return;
            
            const event = getCurrentEvents()[selectedIndex];
            if (event.text && event.text.includes(findText)) {
                saveToHistory();
                event.text = event.text.replace(findText, replaceText);
                renderEventList();
                showToast('1Í±¥ Î∞îÍøà', 'success');
            }
        }

        function replaceAll() {
            const findText = document.getElementById('findText').value;
            const replaceText = document.getElementById('replaceText').value;
            const allDays = document.getElementById('findAllDays').checked;
            
            if (!findText) return;
            
            saveToHistory();
            let count = 0;
            
            const dayIds = allDays ? project.dayList.map(d => d.id) : [currentDay];
            dayIds.forEach(dayId => {
                (project.days[dayId] || []).forEach(event => {
                    if (event.text && event.text.includes(findText)) {
                        event.text = event.text.split(findText).join(replaceText);
                        count++;
                    }
                });
            });
            
            renderEventList();
            showToast(`${count}Í±¥ Î∞îÍøà`, 'success');
            triggerAutoSave();
        }

        // ===== Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ =====
        function foldAll() {
            (getCurrentEvents() || []).forEach((event, index) => {
                if (event.type === 'choice' || event.type === 'condition') {
                    foldedBlocks.add(`${currentDay}-${index}`);
                }
            });
            renderEventList();
        }

        function unfoldAll() {
            foldedBlocks.clear();
            renderEventList();
        }

        // ===== ÎØ∏Î¶¨Î≥¥Í∏∞ =====
        function updatePreview() {
            const currentDayObj = project.dayList.find(d => d.id === currentDay);
            document.getElementById('previewDay').textContent = currentDayObj ? currentDayObj.name : currentDay;
            
            const events = getCurrentEvents() || [];
            if (selectedIndex < 0 || selectedIndex >= events.length) {
                document.getElementById('previewSpeaker').textContent = '';
                document.getElementById('previewText').textContent = 'ÎåÄÏÇ¨Î•º ÏÑ†ÌÉùÌïòÎ©¥ ÎØ∏Î¶¨Î≥¥Í∏∞Í∞Ä ÌëúÏãúÎê©ÎãàÎã§.';
                document.getElementById('previewChoices').innerHTML = '';
                return;
            }
            
            const event = events[selectedIndex];
            
            if (event.type === 'dialogue') {
                const char = project.characters.find(c => c.id === event.speaker);
                document.getElementById('previewSpeaker').textContent = char?.name || event.speaker;
                document.getElementById('previewSpeaker').style.color = char?.color || '#569cd6';
                document.getElementById('previewText').textContent = event.text || '(Îπà ÎåÄÏÇ¨)';
                document.getElementById('previewChoices').innerHTML = '';
            } else if (event.type === 'choice') {
                document.getElementById('previewSpeaker').textContent = '';
                document.getElementById('previewText').textContent = 'ÏÑ†ÌÉùÏßÄÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§.';
                document.getElementById('previewChoices').innerHTML = `
                    <div class="preview-choice nod">ÎÅÑÎçïÏù∏Îã§</div>
                    <div class="preview-choice shake">Ï†ìÎäîÎã§</div>
                `;
            } else {
                document.getElementById('previewSpeaker').textContent = '';
                document.getElementById('previewText').textContent = getEventDisplayText(event).replace(/<[^>]*>/g, '');
                document.getElementById('previewChoices').innerHTML = '';
            }
        }

        // ===== ÌîåÎ°úÏö∞Ï∞®Ìä∏ =====
        function updateFlowchart() {
            const container = document.getElementById('flowchart');
            const events = getCurrentEvents() || [];
            
            container.innerHTML = events.map((event, index) => {
                let cls = `flow-node ${event.type}`;
                if (index === selectedIndex) cls += ' active';
                
                let label = '';
                if (event.type === 'dialogue') label = '‚ñ∑';
                else if (event.type === 'choice') label = '‚óá';
                else if (event.type === 'condition') label = '?';
                else if (event.type === 'label') label = `#${event.name || ''}`;
                else if (event.type === 'jump') label = `‚Üí${event.target || ''}`;
                else if (event.type === 'ending') label = '‚ñ†';
                else label = getEventIcon(event.type);
                
                return `<span class="${cls}" onclick="selectEvent(${index})" title="${index + 1}: ${event.type}">${label}</span>`;
            }).join('');
        }

        // ===== ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ =====
        function updateStatus() {
            let displayName = '';
            if (currentMode === 'common') {
                const currentCommon = project.commonList?.find(c => c.id === currentDay);
                displayName = currentCommon ? `‚óà ${currentCommon.name}` : 'Ïª§Î®º Ïù¥Î≤§Ìä∏';
            } else {
                const currentDayObj = project.dayList.find(d => d.id === currentDay);
                displayName = currentDayObj ? currentDayObj.name : currentDay;
            }
            
            document.getElementById('statusDay').textContent = displayName;
            document.getElementById('statusEventCount').textContent = (getCurrentEvents() || []).length;
            
            // ÏÑ†ÌÉù ÏÉÅÌÉú ÌëúÏãú
            if (selectedIndices.length > 1) {
                document.getElementById('statusLine').textContent = `${selectedIndices.length}Í∞ú ÏÑ†ÌÉù`;
                document.getElementById('statusSelection').textContent = 'Îã§Ï§ë ÏÑ†ÌÉù';
            } else if (selectedIndex >= 0) {
                document.getElementById('statusLine').textContent = `${selectedIndex + 1}Ìñâ`;
                const event = getCurrentEvents()?.[selectedIndex];
                document.getElementById('statusSelection').textContent = event ? event.type : 'ÏÑ†ÌÉù ÏóÜÏùå';
            } else {
                document.getElementById('statusLine').textContent = '-';
                document.getElementById('statusSelection').textContent = 'ÏÑ†ÌÉù ÏóÜÏùå';
            }
            
            document.getElementById('varCurrentDay').textContent = displayName;
        }

        // ===== Ïä§ÌÅ¨Î¶ΩÌä∏ Í≤ÄÏÇ¨ =====
        function validateScript() {
            let errors = [];
            
            // Î™®Îì† Day Í≤ÄÏÇ¨
            project.dayList.forEach(day => {
                const events = project.days[day.id] || [];
                let choiceDepth = 0;
                let conditionDepth = 0;
                
                events.forEach((event, index) => {
                    // Íµ¨Ï°∞ Í∑†Ìòï Í≤ÄÏÇ¨
                    if (event.type === 'choice') choiceDepth++;
                    if (event.type === 'choice-end') choiceDepth--;
                    if (event.type === 'condition') conditionDepth++;
                    if (event.type === 'condition-end') conditionDepth--;
                    
                    // Îπà ÎåÄÏÇ¨ Í≤ΩÍ≥†
                    if (event.type === 'dialogue' && !event.text) {
                        errors.push({ dayName: day.name, index, msg: 'Îπà ÎåÄÏÇ¨Í∞Ä ÏûàÏäµÎãàÎã§.' });
                    }
                    
                    // Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÎùºÎ≤® Ï∞∏Ï°∞
                    if (event.type === 'jump' && event.target) {
                        let found = false;
                        for (const d of project.dayList) {
                            if ((project.days[d.id] || []).some(e => e.type === 'label' && e.name === event.target)) {
                                found = true;
                                break;
                            }
                        }
                        if (!found) {
                            errors.push({ dayName: day.name, index, msg: `Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÎùºÎ≤®: ${event.target}` });
                        }
                    }
                });
                
                if (choiceDepth !== 0) {
                    errors.push({ dayName: day.name, index: -1, msg: 'ÏÑ†ÌÉùÏßÄ Î∂ÑÍ∏∞Í∞Ä Ïò¨Î∞îÎ•¥Í≤å Îã´ÌûàÏßÄ ÏïäÏïòÏäµÎãàÎã§.' });
                }
                if (conditionDepth !== 0) {
                    errors.push({ dayName: day.name, index: -1, msg: 'Ï°∞Í±¥ Î∂ÑÍ∏∞Í∞Ä Ïò¨Î∞îÎ•¥Í≤å Îã´ÌûàÏßÄ ÏïäÏïòÏäµÎãàÎã§.' });
                }
            });
            
            if (errors.length === 0) {
                showToast('Ïò§Î•ò ÏóÜÏùå! ‚úÖ', 'success');
            } else {
                showModal(`
                    <div class="modal-header">Ïä§ÌÅ¨Î¶ΩÌä∏ Í≤ÄÏÇ¨ Í≤∞Í≥º</div>
                    <div class="modal-body">
                        <p style="margin-bottom: 10px;">${errors.length}Í±¥Ïùò Î¨∏Ï†úÍ∞Ä Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§.</p>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${errors.map(e => `
                                <div style="padding: 6px; border-left: 3px solid #f48771; margin-bottom: 4px; background: #2d2d30;">
                                    <strong>${e.dayName}</strong> ${e.index >= 0 ? `${e.index + 1}Ìñâ` : ''}: ${e.msg}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn primary" onclick="closeModal()">ÌôïÏù∏</button>
                    </div>
                `);
            }
        }

        // ===== ÌÜµÍ≥Ñ =====
        function showStats() {
            let totalEvents = 0;
            let dialogueCount = 0;
            let choiceCount = 0;
            let charCounts = {};
            
            project.dayList.forEach(day => {
                (project.days[day.id] || []).forEach(event => {
                    totalEvents++;
                    if (event.type === 'dialogue') {
                        dialogueCount++;
                        charCounts[event.speaker] = (charCounts[event.speaker] || 0) + 1;
                    }
                    if (event.type === 'choice') choiceCount++;
                });
            });
            
            showModal(`
                <div class="modal-header">ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ</div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: #2d2d30; padding: 12px; border-radius: 4px;">
                            <div style="color: #888; font-size: 11px;">Ï¥ù Ïù¥Î≤§Ìä∏</div>
                            <div style="font-size: 24px; color: #4ec9b0;">${totalEvents}</div>
                        </div>
                        <div style="background: #2d2d30; padding: 12px; border-radius: 4px;">
                            <div style="color: #888; font-size: 11px;">ÎåÄÏÇ¨ Ïàò</div>
                            <div style="font-size: 24px; color: #569cd6;">${dialogueCount}</div>
                        </div>
                        <div style="background: #2d2d30; padding: 12px; border-radius: 4px;">
                            <div style="color: #888; font-size: 11px;">ÏÑ†ÌÉùÏßÄ Ïàò</div>
                            <div style="font-size: 24px; color: #dcdcaa;">${choiceCount}</div>
                        </div>
                        <div style="background: #2d2d30; padding: 12px; border-radius: 4px;">
                            <div style="color: #888; font-size: 11px;">Day Ïàò</div>
                            <div style="font-size: 24px; color: #c586c0;">${project.dayList.length}</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="color: #888; font-size: 11px; margin-bottom: 8px;">Ï∫êÎ¶≠ÌÑ∞Î≥Ñ ÎåÄÏÇ¨ Ïàò</div>
                        ${Object.entries(charCounts).map(([id, count]) => {
                            const char = project.characters.find(c => c.id === id);
                            return `<div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="color: ${char?.color || '#888'}">${char?.name || id}</span>
                                <span>${count}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn primary" onclick="closeModal()">ÌôïÏù∏</button>
                </div>
            `);
        }

        // ===== ÏóêÏÖã Í¥ÄÎ¶¨ =====
        function renderAssets() {
            // Î∞∞Í≤Ω
            const bgHtml = (project.assets.backgrounds || []).map((asset, i) => `
                <div class="asset-item" onclick="insertAsset('background', '${asset.path}')">
                    <div class="asset-preview">
                        <img src="assets/${asset.path}" onerror="this.style.display='none'" alt="">
                    </div>
                    <span class="asset-name">${asset.name || asset.path}</span>
                    <div class="asset-actions">
                        <button onclick="event.stopPropagation(); editAsset('backgrounds', ${i})" title="Ìé∏Ïßë">‚úé</button>
                        <button onclick="event.stopPropagation(); deleteAsset('backgrounds', ${i})" title="ÏÇ≠Ï†ú">√ó</button>
                    </div>
                </div>
            `).join('') || '<div style="color: #666; font-size: 11px; padding: 8px;">Îì±Î°ùÎêú Î∞∞Í≤Ω ÏóÜÏùå</div>';
            document.getElementById('assetBg').innerHTML = bgHtml;

            // Ï∫êÎ¶≠ÌÑ∞
            const charHtml = (project.assets.characters || []).map((asset, i) => `
                <div class="asset-item" onclick="insertAsset('character', '${asset.path}')">
                    <div class="asset-preview">
                        <img src="assets/${asset.path}" onerror="this.style.display='none'" alt="">
                    </div>
                    <span class="asset-name">${asset.name || asset.path}</span>
                    <div class="asset-actions">
                        <button onclick="event.stopPropagation(); editAsset('characters', ${i})" title="Ìé∏Ïßë">‚úé</button>
                        <button onclick="event.stopPropagation(); deleteAsset('characters', ${i})" title="ÏÇ≠Ï†ú">√ó</button>
                    </div>
                </div>
            `).join('') || '<div style="color: #666; font-size: 11px; padding: 8px;">Îì±Î°ùÎêú Ï∫êÎ¶≠ÌÑ∞ ÏóÜÏùå</div>';
            document.getElementById('assetChar').innerHTML = charHtml;

            // BGM
            const bgmHtml = (project.assets.bgm || []).map((asset, i) => `
                <div class="asset-item" onclick="insertAsset('bgm', '${asset.path}')">
                    <span class="asset-name">${asset.name || asset.path}</span>
                    <div class="asset-actions">
                        <button onclick="event.stopPropagation(); previewAudio('assets/${asset.path}')" title="Ïû¨ÏÉù">‚ñ∂</button>
                        <button onclick="event.stopPropagation(); editAsset('bgm', ${i})" title="Ìé∏Ïßë">‚úé</button>
                        <button onclick="event.stopPropagation(); deleteAsset('bgm', ${i})" title="ÏÇ≠Ï†ú">√ó</button>
                    </div>
                </div>
            `).join('') || '<div style="color: #666; font-size: 11px; padding: 8px;">Îì±Î°ùÎêú BGM ÏóÜÏùå</div>';
            document.getElementById('assetBgm').innerHTML = bgmHtml;

            // Ìö®Í≥ºÏùå
            const sfxHtml = (project.assets.sfx || []).map((asset, i) => `
                <div class="asset-item" onclick="insertAsset('sfx', '${asset.path}')">
                    <span class="asset-name">${asset.name || asset.path}</span>
                    <div class="asset-actions">
                        <button onclick="event.stopPropagation(); previewAudio('assets/${asset.path}')" title="Ïû¨ÏÉù">‚ñ∂</button>
                        <button onclick="event.stopPropagation(); editAsset('sfx', ${i})" title="Ìé∏Ïßë">‚úé</button>
                        <button onclick="event.stopPropagation(); deleteAsset('sfx', ${i})" title="ÏÇ≠Ï†ú">√ó</button>
                    </div>
                </div>
            `).join('') || '<div style="color: #666; font-size: 11px; padding: 8px;">Îì±Î°ùÎêú Ìö®Í≥ºÏùå ÏóÜÏùå</div>';
            document.getElementById('assetSfx').innerHTML = sfxHtml;
        }

        function addAsset(category) {
            const labels = {
                backgrounds: { title: 'Î∞∞Í≤Ω Ï∂îÍ∞Ä', pathHint: 'bg/room.png' },
                characters: { title: 'Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä', pathHint: 'char/inhui.png' },
                bgm: { title: 'BGM Ï∂îÍ∞Ä', pathHint: 'bgm/theme.mp3' },
                sfx: { title: 'Ìö®Í≥ºÏùå Ï∂îÍ∞Ä', pathHint: 'se/click.mp3' }
            };
            const label = labels[category];

            showModal(`
                <div class="modal-header">${label.title}</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÌååÏùº Í≤ΩÎ°ú (assets/ Í∏∞Ï§Ä)</label>
                        <input type="text" class="form-input" id="assetPath" placeholder="${label.pathHint}">
                        <div class="form-hint">Ïòà: ${label.pathHint}</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">ÌëúÏãú Ïù¥Î¶Ñ (ÏÑ†ÌÉù)</label>
                        <input type="text" class="form-input" id="assetName" placeholder="Î™©Î°ùÏóê ÌëúÏãúÎê† Ïù¥Î¶Ñ">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveNewAsset('${category}')">Ï∂îÍ∞Ä</button>
                </div>
            `);
        }

        function saveNewAsset(category) {
            const path = document.getElementById('assetPath').value.trim();
            const name = document.getElementById('assetName').value.trim();

            if (!path) {
                showToast('ÌååÏùº Í≤ΩÎ°úÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
                return;
            }

            saveToHistory();
            if (!project.assets[category]) project.assets[category] = [];
            project.assets[category].push({ path, name: name || path.split('/').pop() });

            closeModal();
            renderAssets();
            showToast('ÏóêÏÖãÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
            triggerAutoSave();
        }

        function editAsset(category, index) {
            const asset = project.assets[category][index];
            
            showModal(`
                <div class="modal-header">ÏóêÏÖã Ìé∏Ïßë</div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">ÌååÏùº Í≤ΩÎ°ú (assets/ Í∏∞Ï§Ä)</label>
                        <input type="text" class="form-input" id="editAssetPath" value="${asset.path}">
                    </div>
                    <div class="form-row">
                        <label class="form-label">ÌëúÏãú Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-input" id="editAssetName" value="${asset.name || ''}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="saveEditAsset('${category}', ${index})">Ï†ÄÏû•</button>
                </div>
            `);
        }

        function saveEditAsset(category, index) {
            const path = document.getElementById('editAssetPath').value.trim();
            const name = document.getElementById('editAssetName').value.trim();

            if (!path) {
                showToast('ÌååÏùº Í≤ΩÎ°úÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
                return;
            }

            saveToHistory();
            project.assets[category][index] = { path, name: name || path.split('/').pop() };

            closeModal();
            renderAssets();
            showToast('ÏóêÏÖãÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
            triggerAutoSave();
        }

        function deleteAsset(category, index) {
            const asset = project.assets[category][index];
            showConfirmModal(`"${asset.name || asset.path}"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, () => {
                saveToHistory();
                project.assets[category].splice(index, 1);

                renderAssets();
                showToast('ÏóêÏÖãÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                triggerAutoSave();
            });
        }

        let previewAudioEl = null;
        function previewAudio(src) {
            if (previewAudioEl) {
                previewAudioEl.pause();
                previewAudioEl = null;
            }
            previewAudioEl = new Audio(src);
            previewAudioEl.play().catch(() => showToast('Ïò§ÎîîÏò§Î•º Ïû¨ÏÉùÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'warning'));
        }

        function toggleAssetCategory(header) {
            const list = header.nextElementSibling;
            list.style.display = list.style.display === 'none' ? '' : 'none';
            header.querySelector('span').textContent = list.style.display === 'none' ? '‚ñ∂' : '‚ñº';
        }

        function filterAssets(query) {
            const q = query.toLowerCase();
            document.querySelectorAll('.asset-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(q) ? '' : 'none';
            });
        }

        function insertAsset(type, file) {
            if (type === 'background') {
                addCommand('background');
                setTimeout(() => {
                    const event = getCurrentEvents()[selectedIndex];
                    if (event) event.file = file;
                    renderEventList();
                }, 100);
            } else if (type === 'bgm') {
                addCommand('bgm');
                setTimeout(() => {
                    const event = getCurrentEvents()[selectedIndex];
                    if (event) event.file = file;
                    renderEventList();
                }, 100);
            } else if (type === 'sfx') {
                addCommand('sfx');
                setTimeout(() => {
                    const event = getCurrentEvents()[selectedIndex];
                    if (event) event.file = file;
                    renderEventList();
                }, 100);
            } else if (type === 'character') {
                addCommand('character');
                setTimeout(() => {
                    const event = getCurrentEvents()[selectedIndex];
                    if (event) event.image = file;
                    renderEventList();
                }, 100);
            }
        }

        // ===== Ïã§ÌñâÏ∑®ÏÜå/Îã§ÏãúÏã§Ìñâ =====
        function saveToHistory() {
            undoHistory = undoHistory.slice(0, historyIndex + 1);
            undoHistory.push(JSON.stringify(project));
            historyIndex = undoHistory.length - 1;
            
            if (undoHistory.length > 50) {
                undoHistory.shift();
                historyIndex--;
            }
        }

        function undo() {
            if (historyIndex <= 0) {
                showToast('Îçî Ïù¥ÏÉÅ Ïã§ÌñâÏ∑®ÏÜåÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                return;
            }
            historyIndex--;
            project = JSON.parse(undoHistory[historyIndex]);
            renderAll();
            showToast('Ïã§ÌñâÏ∑®ÏÜå', 'success');
        }

        function redo() {
            if (historyIndex >= undoHistory.length - 1) {
                showToast('Îçî Ïù¥ÏÉÅ Îã§ÏãúÏã§ÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                return;
            }
            historyIndex++;
            project = JSON.parse(undoHistory[historyIndex]);
            renderAll();
            showToast('Îã§ÏãúÏã§Ìñâ', 'success');
        }

        function renderAll() {
            renderDayList();
            renderCommonList();
            renderCharList();
            renderEventList();
            updateStatus();
            updatePreview();
        }

        // ===== ÌååÏùº Í¥ÄÎ¶¨ =====
        function newProject() {
            showConfirmModal('ÏÉà ÌîÑÎ°úÏ†ùÌä∏Î•º ÎßåÎì§ÍπåÏöî?\nÏ†ÄÏû•ÌïòÏßÄ ÏïäÏùÄ ÎÇ¥Ïö©ÏùÄ ÏÇ¨ÎùºÏßëÎãàÎã§.', () => {
                project = {
                    config: { title: "Îã¨Ïùò ÏÑ∏Í≥Ñ", version: "1.0" },
                    characters: [
                        { id: 'inhui', name: 'Ïù∏Ïô∏', color: '#569cd6', image: '' },
                        { id: 'narration', name: 'ÎÇòÎ†àÏù¥ÏÖò', color: '#888888', image: '' }
                    ],
                    assets: { backgrounds: [], characters: [], bgm: [], sfx: [] },
                    dayList: [
                        { id: 'day1', name: '1ÏùºÏ∞®' }
                    ],
                    days: { day1: [] },
                    commonList: [],
                    commons: {},
                    bookmarks: []
                };
                
                currentDay = 'day1';
                selectedIndex = -1;
                selectedIndices = [];
                undoHistory = [];
                historyIndex = -1;
                saveToHistory();
                renderAll();
                localStorage.removeItem('tacetEditorAutoSave');
                showToast('ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±Îê®', 'success');
            });
        }

        function exportJSON() {
            const dataStr = JSON.stringify(project, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `tacet_${project.config.title}_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast('Ï†ÄÏû• ÏôÑÎ£å', 'success');
        }

        function importJSON() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.days) {
                        project = data;
                        // Ïù¥Ï†Ñ Î≤ÑÏ†Ñ Ìò∏ÌôòÏÑ±
                        if (!project.characters) {
                            project.characters = [
                                { id: 'inhui', name: 'Ïù∏Ïô∏', color: '#569cd6', image: '' },
                                { id: 'narration', name: 'ÎÇòÎ†àÏù¥ÏÖò', color: '#888888', image: '' }
                            ];
                        }
                        if (!project.bookmarks) project.bookmarks = [];
                        if (!project.assets) project.assets = { backgrounds: [], characters: [], bgm: [], sfx: [] };
                        
                        // dayListÍ∞Ä ÏóÜÏúºÎ©¥ Ïù¥Ï†Ñ Î≤ÑÏ†Ñ - Î≥ÄÌôò ÌïÑÏöî
                        if (!project.dayList) {
                            project.dayList = [];
                            const newDays = {};
                            Object.keys(project.days).sort((a, b) => parseInt(a) - parseInt(b)).forEach((key, idx) => {
                                const newId = 'day' + key;
                                project.dayList.push({ id: newId, name: `${key}ÏùºÏ∞®` });
                                newDays[newId] = project.days[key];
                            });
                            project.days = newDays;
                        }
                        
                        currentDay = project.dayList.length > 0 ? project.dayList[0].id : 'day1';
                        selectedIndex = -1;
                        undoHistory = [];
                        historyIndex = -1;
                        saveToHistory();
                        renderAll();
                        showToast('Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å', 'success');
                    } else {
                        throw new Error('Invalid format');
                    }
                } catch (err) {
                    showToast('Ïò¨Î∞îÎ•∏ ÌòïÏãùÏùò ÌååÏùºÏù¥ ÏïÑÎãôÎãàÎã§.', 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        // ===== ÏûêÎèô Ï†ÄÏû• =====
        function autoSave() {
            try {
                localStorage.setItem('tacetEditorAutoSave', JSON.stringify(project));
                const indicator = document.getElementById('autoSaveIndicator');
                indicator.textContent = '‚óè Ï†ÄÏû•Îê®';
                indicator.classList.remove('saving');
            } catch (e) {
                console.warn('Auto-save failed:', e);
            }
        }

        function triggerAutoSave() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.textContent = '‚óã Ï†ÄÏû• Ï§ë...';
            indicator.classList.add('saving');
            
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(autoSave, 2000);
        }

        function loadAutoSave() {
            try {
                const saved = localStorage.getItem('tacetEditorAutoSave');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.days) {
                        showConfirmModal('Ïù¥Ï†Ñ ÏûëÏóÖÏùÑ Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå?', () => {
                            project = data;
                            if (!project.characters) {
                                project.characters = [
                                    { id: 'inhui', name: 'Ïù∏Ïô∏', color: '#569cd6', image: '' },
                                    { id: 'narration', name: 'ÎÇòÎ†àÏù¥ÏÖò', color: '#888888', image: '' }
                                ];
                            }
                            if (!project.bookmarks) project.bookmarks = [];
                            if (!project.assets) project.assets = { backgrounds: [], characters: [], bgm: [], sfx: [] };
                            
                            // dayListÍ∞Ä ÏóÜÏúºÎ©¥ Ïù¥Ï†Ñ Î≤ÑÏ†Ñ - Î≥ÄÌôò ÌïÑÏöî
                            if (!project.dayList) {
                                project.dayList = [];
                                const newDays = {};
                                Object.keys(project.days).sort((a, b) => parseInt(a) - parseInt(b)).forEach((key, idx) => {
                                    const newId = 'day' + key;
                                    project.dayList.push({ id: newId, name: `${key}ÏùºÏ∞®` });
                                    newDays[newId] = project.days[key];
                                });
                                project.days = newDays;
                            }
                            
                            currentDay = project.dayList.length > 0 ? project.dayList[0].id : 'day1';
                            renderAll();
                            showToast('Ïù¥Ï†Ñ ÏûëÏóÖ Î≥µÏõêÎê®', 'success');
                        });
                    }
                }
            } catch (e) {
                console.warn('Auto-save load failed:', e);
            }
            saveToHistory();
        }

        // ===== Î™®Îã¨ =====
        function showModal(content) {
            document.getElementById('modal').innerHTML = content;
            document.getElementById('modalOverlay').classList.add('active');
        }

        // ÌôïÏù∏ Î™®Îã¨ (confirm ÎåÄÏ≤¥)
        let confirmCallback = null;
        
        function showConfirmModal(message, onConfirm) {
            confirmCallback = onConfirm;
            showModal(`
                <div class="modal-header">ÌôïÏù∏</div>
                <div class="modal-body">
                    <p style="white-space: pre-line; line-height: 1.6;">${message}</p>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn primary" onclick="executeConfirm()">ÌôïÏù∏</button>
                </div>
            `);
        }
        
        function executeConfirm() {
            const callback = confirmCallback;
            closeModal();
            if (callback) {
                callback();
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            confirmCallback = null;
        }

        function closeModalOutside(e) {
            if (e.target === e.currentTarget) closeModal();
        }

        // ===== ÌÜ†Ïä§Ìä∏ =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // ===== Ï¥àÍ∏∞Ìôî Ïã§Ìñâ =====
        init();
    </script>
</body>
</html>
